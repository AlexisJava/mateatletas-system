# Schema Prisma Unificado - Mateatletas

Este documento presenta el schema completo de Prisma integrando todos los slices del sistema.

---

## Configuraci√≥n

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
```

---

## Enums

```prisma
// Estados de Membres√≠a (Pagos)
enum EstadoMembresia {
  Pendiente    // Pago iniciado, esperando webhook
  Activa       // Pago confirmado
  Atrasada     // Pago vencido
  Cancelada    // Cancelada manualmente o pago rechazado
}

// Estados de Inscripci√≥n a Curso (Pagos)
enum EstadoInscripcionCurso {
  PreInscrito  // Comprado pero curso no inici√≥
  Activo       // Cursando
  Finalizado   // Curso completado
}

// Estados de Clase (Clases)
enum EstadoClase {
  Programada
  Cancelada
}

// Estados de Asistencia (Asistencia)
enum EstadoAsistencia {
  Pendiente
  Asistio
  Ausente
}

// Tipos de Producto (Cat√°logo)
enum TipoProducto {
  Suscripcion     // Membres√≠a mensual
  Curso           // Curso de pago √∫nico
  RecursoDigital  // Libros, materiales (futuro)
}

// Categor√≠as de Logro (Gamificaci√≥n)
enum CategoriaLogro {
  Participacion
  Asistencia
  Desafios
  Especial
}
```

---

## Modelos de Usuarios

```prisma
// ============================================
// USUARIOS
// ============================================

// Administrador del Sistema
model Admin {
  id        Int      @id @default(autoincrement())
  nombre    String
  apellido  String
  email     String   @unique
  password  String   // Hash bcrypt
  role      String   @default("Admin")
  creadoEn  DateTime @default(now())
  actualizadoEn DateTime @updatedAt
}

// Tutor (Padre/Responsable que paga)
model Tutor {
  id        Int      @id @default(autoincrement())
  nombre    String
  apellido  String
  email     String   @unique
  password  String   // Hash bcrypt
  telefono  String?

  // Relaciones
  estudiantes Estudiante[]
  membresias  Membresia[]

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt
}

// Estudiante (Hijo del Tutor)
model Estudiante {
  id               Int      @id @default(autoincrement())
  nombre           String
  apellido         String
  fechaNacimiento  DateTime?
  email            String?  @unique  // Opcional para login propio
  password         String?  // Hash bcrypt

  // Relaciones
  tutorId          Int
  tutor            Tutor    @relation(fields: [tutorId], references: [id])

  equipoId         Int?
  equipo           Equipo?  @relation(fields: [equipoId], references: [id])

  // Relaciones inversas
  inscripciones         Inscripcion[]
  inscripcionesCurso    InscripcionCurso[]
  puntos                Punto[]
  logros                EstudianteLogro[]
  alertas               Alerta[]

  creadoEn         DateTime @default(now())
  actualizadoEn    DateTime @updatedAt
}

// Docente (Profesor)
model Docente {
  id        Int      @id @default(autoincrement())
  nombre    String
  apellido  String
  email     String   @unique
  password  String   // Hash bcrypt
  titulo    String?  // "Profesor de Matem√°tica"
  bio       String?  // Descripci√≥n

  // Relaciones
  clases    Clase[]
  puntos    Punto[]  // Puntos que otorg√≥

  creadoEn  DateTime @default(now())
  actualizadoEn DateTime @updatedAt
}
```

---

## Modelos de Cat√°logo y Pagos

```prisma
// ============================================
// CAT√ÅLOGO
// ============================================

model Producto {
  id            Int          @id @default(autoincrement())
  nombre        String
  descripcion   String?
  precio        Decimal      @db.Decimal(10,2)
  tipo          TipoProducto

  // Campos espec√≠ficos de Curso
  fechaInicio   DateTime?
  fechaFin      DateTime?
  cupoMaximo    Int?

  // Relaciones
  membresias           Membresia[]
  inscripcionesCurso   InscripcionCurso[]
  clases               Clase[]  // Clases vinculadas a un curso
}

// ============================================
// PAGOS
// ============================================

model Membresia {
  id               Int      @id @default(autoincrement())
  tutorId          Int
  tutor            Tutor    @relation(fields: [tutorId], references: [id])
  productoId       Int
  producto         Producto @relation(fields: [productoId], references: [id])

  estado           EstadoMembresia @default(Pendiente)
  fechaInicio      DateTime?      // Se llena cuando webhook confirma
  fechaProximoPago DateTime?      // Pr√≥ximo vencimiento
  preferenciaId    String?        // ID de MercadoPago para tracking

  creadoEn         DateTime @default(now())

  @@unique([tutorId, productoId])
}

model InscripcionCurso {
  id               Int      @id @default(autoincrement())
  estudianteId     Int
  estudiante       Estudiante @relation(fields: [estudianteId], references: [id])
  productoId       Int
  producto         Producto   @relation(fields: [productoId], references: [id])

  estado           EstadoInscripcionCurso
  fechaInscripcion DateTime @default(now())

  @@unique([estudianteId, productoId])
}
```

---

## Modelos Acad√©micos

```prisma
// ============================================
// ACAD√âMICO
// ============================================

model RutaCurricular {
  id     Int      @id @default(autoincrement())
  nombre String   @unique  // "L√≥gica", "√Ålgebra", "Geometr√≠a"
  clases Clase[]
}

model Clase {
  id               Int      @id @default(autoincrement())

  rutaCurricularId Int
  rutaCurricular   RutaCurricular @relation(fields: [rutaCurricularId], references: [id])

  docenteId        Int
  docente          Docente @relation(fields: [docenteId], references: [id])

  fechaHoraInicio  DateTime
  duracionMinutos  Int
  estado           EstadoClase
  cuposMaximo      Int
  cuposOcupados    Int      @default(0)

  // Vinculaci√≥n a curso (opcional)
  productoId       Int?
  producto         Producto? @relation(fields: [productoId], references: [id])

  // Relaciones
  inscripciones    Inscripcion[]
  alertas          Alerta[]
  puntos           Punto[]
}

model Inscripcion {
  id                   Int      @id @default(autoincrement())

  claseId              Int
  clase                Clase    @relation(fields: [claseId], references: [id])

  estudianteId         Int
  estudiante           Estudiante @relation(fields: [estudianteId], references: [id])

  estadoAsistencia     EstadoAsistencia @default(Pendiente)
  observacionesDocente String?

  @@unique([claseId, estudianteId])  // Un estudiante no puede reservar 2 veces la misma clase
}
```

---

## Modelos de Gamificaci√≥n

```prisma
// ============================================
// GAMIFICACI√ìN
// ============================================

model Equipo {
  id          Int      @id @default(autoincrement())
  nombre      String   @unique  // "Los Algoritmos", "Los Fractales"
  color       String   // C√≥digo hex: "#3B82F6"
  estudiantes Estudiante[]
}

model Punto {
  id           Int      @id @default(autoincrement())

  estudianteId Int
  estudiante   Estudiante @relation(fields: [estudianteId], references: [id])

  cantidad     Int      // Puntos otorgados (siempre positivo)
  razon        String   // "Participaci√≥n activa", "Excelente trabajo"

  claseId      Int?
  clase        Clase?   @relation(fields: [claseId], references: [id])

  docenteId    Int
  docente      Docente  @relation(fields: [docenteId], references: [id])

  fecha        DateTime @default(now())

  @@index([estudianteId])
  @@index([fecha])
}

model Logro {
  id               Int      @id @default(autoincrement())
  nombre           String   @unique  // "Primer Paso", "Maestro de la L√≥gica"
  descripcion      String   // "Obt√©n tus primeros 10 puntos"
  icono            String   // Emoji o URL: "üåü", "üèÜ"
  puntosRequeridos Int      // Umbral para desbloquear
  categoria        CategoriaLogro

  estudiantesLogros EstudianteLogro[]
}

model EstudianteLogro {
  id             Int      @id @default(autoincrement())

  estudianteId   Int
  estudiante     Estudiante @relation(fields: [estudianteId], references: [id])

  logroId        Int
  logro          Logro    @relation(fields: [logroId], references: [id])

  fechaObtenido  DateTime @default(now())

  @@unique([estudianteId, logroId])  // Un estudiante no puede obtener el mismo logro 2 veces
}
```

---

## Modelos de Admin

```prisma
// ============================================
// ADMIN
// ============================================

model Alerta {
  id           Int      @id @default(autoincrement())

  estudianteId Int
  estudiante   Estudiante @relation(fields: [estudianteId], references: [id])

  claseId      Int
  clase        Clase    @relation(fields: [claseId], references: [id])

  descripcion  String   // Observaci√≥n del docente que dispar√≥ la alerta
  fecha        DateTime @default(now())
  resuelta     Boolean  @default(false)

  @@index([resuelta])
  @@index([fecha])
}
```

---

## Resumen de Relaciones

### Relaciones One-to-Many (1:N)

| Modelo Padre | Modelo Hijo | Campo FK |
|--------------|-------------|----------|
| **Tutor** | Estudiante | tutorId |
| **Tutor** | Membresia | tutorId |
| **Equipo** | Estudiante | equipoId |
| **Producto** | Membresia | productoId |
| **Producto** | InscripcionCurso | productoId |
| **Producto** | Clase | productoId |
| **RutaCurricular** | Clase | rutaCurricularId |
| **Docente** | Clase | docenteId |
| **Docente** | Punto | docenteId |
| **Clase** | Inscripcion | claseId |
| **Clase** | Alerta | claseId |
| **Clase** | Punto | claseId |
| **Estudiante** | Inscripcion | estudianteId |
| **Estudiante** | InscripcionCurso | estudianteId |
| **Estudiante** | Punto | estudianteId |
| **Estudiante** | EstudianteLogro | estudianteId |
| **Estudiante** | Alerta | estudianteId |
| **Logro** | EstudianteLogro | logroId |

### Relaciones Many-to-Many (M:N)

Implementadas via tablas intermedias:

- **Estudiante ‚Üî Clase**: via `Inscripcion`
- **Estudiante ‚Üî Logro**: via `EstudianteLogro`
- **Estudiante ‚Üî Producto (Curso)**: via `InscripcionCurso`

---

## √çndices y Constraints

### Unique Constraints

```prisma
// Emails √∫nicos
Admin.email
Tutor.email
Estudiante.email
Docente.email

// Nombres √∫nicos
Producto.nombre (recomendado)
RutaCurricular.nombre
Equipo.nombre
Logro.nombre

// Combinaciones √∫nicas
Membresia: @@unique([tutorId, productoId])
InscripcionCurso: @@unique([estudianteId, productoId])
Inscripcion: @@unique([claseId, estudianteId])
EstudianteLogro: @@unique([estudianteId, logroId])
```

### √çndices de Performance

```prisma
// B√∫squedas frecuentes
Punto: @@index([estudianteId])
Punto: @@index([fecha])
Alerta: @@index([resuelta])
Alerta: @@index([fecha])
```

---

## Diagrama de Entidades (Simplificado)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Tutor   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Estudiante  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Equipo  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ                    ‚îÇ
     ‚îÇ                    ‚îÇ
     ‚ñº                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇMembresia ‚îÇ       ‚îÇInscripcion  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ   Curso     ‚îÇ
     ‚îÇ             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ                    ‚îÇ
     ‚ñº                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Producto ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ    Clase    ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îÇ
                          ‚îÇ                     ‚îÇ
                          ‚îÇ                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                          ‚îÇ                ‚îÇ  Docente ‚îÇ
                          ‚îÇ                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚ñº
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇInscripcion  ‚îÇ
                   ‚îÇ  (a Clase)  ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
                          ‚ñº
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ   Alerta    ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         GAMIFICACI√ìN                     ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ  Estudiante ‚îÄ‚îÄ‚ñ∂ Punto ‚óÄ‚îÄ‚îÄ Docente       ‚îÇ
‚îÇ       ‚îÇ                                  ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ‚îÄ‚ñ∂ EstudianteLogro ‚óÄ‚îÄ‚îÄ Logro   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Comandos √ötiles

```bash
# Generar Prisma Client
npx prisma generate

# Crear migraci√≥n
npx prisma migrate dev --name nombre_descriptivo

# Aplicar migraciones
npx prisma migrate deploy

# Ver base de datos con UI
npx prisma studio

# Resetear base de datos (‚ö†Ô∏è ELIMINA DATOS)
npx prisma migrate reset

# Verificar schema
npx prisma validate

# Formatear schema
npx prisma format
```

---

## Migraciones por Orden

Orden sugerido para crear migraciones (evitar dependencias rotas):

1. **Enums** (todos los enums primero)
2. **Admin** (modelo base)
3. **Tutor** (modelo base)
4. **Equipo** (para vincular con Estudiante)
5. **Estudiante** (depende de Tutor y Equipo)
6. **Docente** (modelo base)
7. **Producto** (modelo base)
8. **RutaCurricular** (para vincular con Clase)
9. **Membresia** (depende de Tutor y Producto)
10. **InscripcionCurso** (depende de Estudiante y Producto)
11. **Clase** (depende de RutaCurricular, Docente, Producto)
12. **Inscripcion** (depende de Clase y Estudiante)
13. **Logro** (modelo base)
14. **Punto** (depende de Estudiante, Docente, Clase)
15. **EstudianteLogro** (depende de Estudiante y Logro)
16. **Alerta** (depende de Estudiante y Clase)

Comando para crear migraci√≥n √∫nica con todo:
```bash
npx prisma migrate dev --name initial_setup
```

---

## Notas de Implementaci√≥n

### Passwords
Todos los campos `password` deben hashearse con **bcrypt** (salt rounds: 10) antes de guardar en DB.

```typescript
import * as bcrypt from 'bcrypt';

const hashedPassword = await bcrypt.hash(plainPassword, 10);
```

### Decimales
El campo `Producto.precio` usa `Decimal` para evitar errores de punto flotante en c√°lculos monetarios.

### Timestamps
Todos los modelos principales tienen `creadoEn` y `actualizadoEn` para auditor√≠a.

### Soft Deletes
Actualmente no implementado. Si se necesita, agregar campo `deletedAt DateTime?` y filtrar en queries.

### Email √önicos Globales
Los emails son √∫nicos **por tabla**, no globalmente. Esto permite que un Tutor y un Docente tengan el mismo email (aunque no es recomendado en producci√≥n).

---

## Testing del Schema

```bash
# 1. Crear base de datos de prueba
createdb mateatletas_test

# 2. Actualizar .env.test
DATABASE_URL="postgresql://user:pass@localhost:5432/mateatletas_test"

# 3. Migrar
npx prisma migrate dev

# 4. Ejecutar seed
npm run seed

# 5. Verificar datos
npx prisma studio
```

---

**√öltima actualizaci√≥n**: 2025-01-12
**Versi√≥n**: 1.0
**Autor**: Sistema Mateatletas
