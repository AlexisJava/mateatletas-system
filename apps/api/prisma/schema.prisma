generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Modelo principal para tutores/docentes de la plataforma
/// Representa a los usuarios educadores que crean y gestionan contenido educativo
model Tutor {
  /// Identificador √∫nico del tutor (CUID para mejor distribuci√≥n)
  id                        String                  @id @default(cuid())
  /// Username √∫nico del tutor - usado para autenticaci√≥n alternativa
  username                  String?                 @unique
  /// Email √∫nico del tutor - usado para autenticaci√≥n
  /// IMPORTANTE: Debe estar indexado para b√∫squedas r√°pidas en login
  email                     String?                 @unique
  /// Hash bcrypt de la contrase√±a - NUNCA se env√≠a al frontend
  /// Se maneja solo en backend para seguridad
  password_hash             String
  /// Indica si el tutor debe completar su perfil (datos personales adicionales)
  debe_completar_perfil     Boolean                 @default(false)
  /// Fecha del √∫ltimo cambio de contrase√±a
  fecha_ultimo_cambio       DateTime?
  /// Nombre del tutor
  nombre                    String
  /// Apellido del tutor
  apellido                  String
  /// Documento Nacional de Identidad (opcional)
  dni                       String?
  /// CUIL/CUIT para facturaci√≥n (REQUERIDO para inscripciones 2026)
  cuil                      String?
  /// Tel√©fono de contacto (opcional)
  telefono                  String?
  /// Fecha en que el tutor se registr√≥ en la plataforma
  fecha_registro            DateTime                @default(now())
  /// Indica si el tutor complet√≥ el proceso de onboarding inicial
  /// Se usa para redirigir a nuevos tutores al flujo de configuraci√≥n
  ha_completado_onboarding  Boolean                 @default(false)
  /// Timestamp de creaci√≥n del registro
  createdAt                 DateTime                @default(now())
  /// Timestamp de √∫ltima actualizaci√≥n del registro
  updatedAt                 DateTime                @updatedAt
  /// Roles asignados al tutor (normalmente solo ["tutor"])
  /// Ejemplo: ["tutor"]
  roles                     Json                    @default("[\"tutor\"]")
  estudiantes               Estudiante[]
  inscripciones_clase       InscripcionClase[]
  inscripciones_clase_grupo InscripcionClaseGrupo[]
  inscripciones_mensuales   InscripcionMensual[]

  /// COLONIA DE VERANO
  inscripciones_colonia ColoniaInscripcion[]

  /// SUSCRIPCIONES RECURRENTES (PreApproval MercadoPago)
  suscripciones Suscripcion[]

  @@map("tutores")
}

/// Modelo para estudiantes asociados a un tutor
/// Representa a los alumnos que utilizar√°n la plataforma
model Estudiante {
  /// Identificador √∫nico del estudiante
  id                        String                  @id @default(cuid())
  /// Username √∫nico del estudiante - usado para autenticaci√≥n (OBLIGATORIO)
  username                  String                  @unique
  /// Nombre del estudiante
  nombre                    String
  /// Apellido del estudiante
  apellido                  String
  /// Nivel escolar del estudiante: Primaria, Secundaria, Universidad
  nivelEscolar              String                  @map("nivel_escolar")
  /// URL del avatar 3D de Ready Player Me
  /// Ejemplo: https://models.readyplayer.me/abc123.glb
  avatarUrl                 String?                 @map("avatar_url") @db.Text
  /// URL de la animaci√≥n idle seleccionada por el estudiante
  /// Ejemplo: https://bx0qberriuipqy7z.public.blob.vercel-storage.com/animations/masculine/idle/M_Standing_Idle_001.glb
  animacion_idle_url        String?                 @db.Text
  /// DEPRECADO: URL de la foto de perfil del estudiante (mantener por compatibilidad)
  fotoUrl                   String?                 @map("foto_url")
  /// ID del tutor que gestiona este estudiante
  tutor_id                  String
  /// ID de la casa a la que pertenece el estudiante (sistema 2026)
  casaId                    String?                 @map("casa_id")
  /// Nivel actual del estudiante en el sistema de gamificaci√≥n
  /// NOTA: puntos_totales fue migrado a RecursosEstudiante.xp_total (SUB-FASE 1.3)
  nivel_actual              Int                     @default(1)
  /// Timestamp de creaci√≥n del registro
  createdAt                 DateTime                @default(now())
  /// Timestamp de √∫ltima actualizaci√≥n del registro
  updatedAt                 DateTime                @updatedAt
  /// ID del gradiente del avatar (0-9)
  /// Corresponde a uno de los 10 gradientes predefinidos del sistema
  avatar_gradient           Int                     @default(0)
  /// Edad del estudiante en a√±os
  edad                      Int
  /// Email √∫nico del estudiante - usado para autenticaci√≥n propia
  /// IMPORTANTE: Debe estar indexado para b√∫squedas r√°pidas en login
  email                     String?                 @unique
  /// Hash bcrypt de la contrase√±a - NUNCA se env√≠a al frontend
  /// Permite que el estudiante acceda al portal con sus propias credenciales
  password_hash             String?
  /// Fecha del √∫ltimo cambio de contrase√±a
  fecha_ultimo_cambio       DateTime?
  /// Roles asignados al estudiante (normalmente solo ["estudiante"])
  /// Ejemplo: ["estudiante"]
  roles                     Json                    @default("[\"estudiante\"]")
  /// DEPRECADO: ID del sector al que pertenece el estudiante (usar sectores[] en su lugar)
  /// Mantener temporalmente para migraci√≥n gradual
  sector_id                 String?
  alertas                   Alerta[]
  asistencias               Asistencia[]
  casa                      Casa?                   @relation(fields: [casaId], references: [id])
  sector                    Sector?                 @relation("EstudianteSectorLegacy", fields: [sector_id], references: [id])
  tutor                     Tutor                   @relation(fields: [tutor_id], references: [id], onDelete: Cascade)
  inscripciones_clase       InscripcionClase[]
  inscripciones_clase_grupo InscripcionClaseGrupo[]
  asistencias_clase_grupo   AsistenciaClaseGrupo[]
  puntosObtenidos           PuntoObtenido[]
  inscripciones_mensuales   InscripcionMensual[]
  recursos                  RecursosEstudiante?

  /// GAMIFICACI√ìN V2
  logros_desbloqueados LogroEstudiante[]
  racha                RachaEstudiante?

  /// COLONIA DE VERANO
  colonia_inscripciones ColoniaEstudiante[]

  /// SANDBOX: Progreso en contenidos educativos
  progresosContenido ProgresoContenido[]

  // √çndices de performance para rankings y listados
  // NOTA: √çndices de puntos_totales eliminados - usar RecursosEstudiante para rankings (SUB-FASE 1.3)
  @@index([tutor_id, apellido], name: "idx_estudiantes_tutor_listado")
  @@map("estudiantes")
}

/// Modelo para casas del sistema 2026
/// Las casas agrupan estudiantes por rango de edad con colores y gamificaci√≥n propios
/// Reemplaza el modelo Equipo anterior
model Casa {
  /// Identificador √∫nico de la casa
  id     String   @id @default(cuid())
  /// Tipo de casa (QUANTUM, VERTEX, PULSAR) - √∫nico
  tipo   CasaTipo @unique
  /// Nombre de la casa para mostrar
  nombre String   @unique
  /// Emoji representativo de la casa
  emoji  String
  /// Slogan o lema de la casa
  slogan String?

  /// Edad m√≠nima para pertenecer a esta casa
  edadMinima Int @map("edad_minima")
  /// Edad m√°xima para pertenecer a esta casa
  edadMaxima Int @map("edad_maxima")

  /// Color primario en formato hexadecimal (Design System 2026)
  colorPrimary   String @map("color_primary")
  /// Color secundario en formato hexadecimal
  colorSecondary String @map("color_secondary")
  /// Color de acento en formato hexadecimal
  colorAccent    String @map("color_accent")
  /// Color oscuro en formato hexadecimal
  colorDark      String @map("color_dark")
  /// Gradiente CSS para backgrounds
  gradiente      String

  /// Puntos totales acumulados por todos los estudiantes de la casa
  puntosTotales Int @default(0) @map("puntos_totales")

  /// Timestamp de creaci√≥n del registro
  createdAt DateTime @default(now())
  /// Timestamp de √∫ltima actualizaci√≥n del registro
  updatedAt DateTime @updatedAt

  /// Estudiantes que pertenecen a esta casa
  estudiantes Estudiante[]

  @@map("casas")
}

/// Modelo para Mundos STEAM (2026)
/// Representa las 3 √°reas de conocimiento: Matem√°tica, Programaci√≥n, Ciencias
model Mundo {
  /// Identificador √∫nico del mundo
  id          String    @id @default(cuid())
  /// Tipo de mundo (MATEMATICA, PROGRAMACION, CIENCIAS) - √∫nico
  tipo        MundoTipo @unique
  /// Nombre del mundo para mostrar
  nombre      String    @unique
  /// Descripci√≥n del mundo
  descripcion String?
  /// Icono del mundo (emoji o nombre de icono)
  icono       String

  /// Color primario en formato hexadecimal
  colorPrimary   String @map("color_primary")
  /// Color secundario en formato hexadecimal
  colorSecondary String @map("color_secondary")
  /// Color de acento en formato hexadecimal
  colorAccent    String @map("color_accent")
  /// Gradiente CSS para backgrounds
  gradiente      String

  /// Indica si el mundo est√° activo
  activo Boolean @default(true)
  /// Orden de visualizaci√≥n
  orden  Int     @default(0)

  /// Timestamp de creaci√≥n del registro
  createdAt DateTime @default(now())
  /// Timestamp de √∫ltima actualizaci√≥n del registro
  updatedAt DateTime @updatedAt

  // √çndice de performance para filtros de mundos activos
  @@index([activo], name: "idx_mundos_activo")
  @@map("mundos")
}

// ============================================================================
// SISTEMA DE CONTENIDO EDUCATIVO (SANDBOX)
// ============================================================================

/// Contenido educativo (lecci√≥n) creada en el Sandbox
/// Una lecci√≥n completa con m√∫ltiples slides para estudiantes
model Contenido {
  /// Identificador √∫nico del contenido
  id String @id @default(cuid())

  /// T√≠tulo de la lecci√≥n
  titulo String

  /// Casa objetivo (QUANTUM, VERTEX, PULSAR)
  /// Define qu√© estudiantes pueden ver este contenido
  casaTipo CasaTipo @map("casa_tipo")

  /// Mundo/materia (MATEMATICA, PROGRAMACION, CIENCIAS)
  mundoTipo MundoTipo @map("mundo_tipo")

  /// Estado actual del contenido
  estado EstadoContenido @default(BORRADOR)

  /// ID del admin que cre√≥ el contenido
  creadorId String @map("creador_id")

  /// Descripci√≥n o resumen (opcional)
  descripcion String?

  /// URL de imagen de portada (opcional)
  imagenPortada String? @map("imagen_portada")

  /// Orden de visualizaci√≥n dentro de la casa/mundo
  orden Int @default(0)

  /// Duraci√≥n estimada en minutos
  duracionMinutos Int? @map("duracion_minutos")

  /// Fecha de publicaci√≥n (null si es borrador)
  fechaPublicacion DateTime? @map("fecha_publicacion")

  /// Timestamp de creaci√≥n del registro
  createdAt DateTime @default(now())

  /// Timestamp de √∫ltima actualizaci√≥n del registro
  updatedAt DateTime @updatedAt

  /// Relaciones
  creador   Admin               @relation(fields: [creadorId], references: [id])
  slides    Slide[]
  progresos ProgresoContenido[]

  @@index([casaTipo, mundoTipo, estado], name: "idx_contenidos_casa_mundo_estado")
  @@index([creadorId], name: "idx_contenidos_creador")
  @@index([estado], name: "idx_contenidos_estado")
  @@map("contenidos")
}

/// Slide individual dentro de un Contenido
/// Cada slide contiene JSON que el frontend renderiza como componentes
model Slide {
  /// Identificador √∫nico del slide
  id String @id @default(cuid())

  /// ID del contenido padre
  contenidoId String @map("contenido_id")

  /// T√≠tulo del slide
  titulo String

  /// Contenido JSON (estructura ContentBlock serializada)
  /// Se almacena como JSON string que el frontend parsea
  contenidoJson String @map("contenido_json") @db.Text

  /// Orden del slide dentro de la lecci√≥n
  orden Int @default(0)

  /// Timestamp de creaci√≥n del registro
  createdAt DateTime @default(now())

  /// Timestamp de √∫ltima actualizaci√≥n del registro
  updatedAt DateTime @updatedAt

  /// Relaciones
  contenido Contenido @relation(fields: [contenidoId], references: [id], onDelete: Cascade)

  @@index([contenidoId], name: "idx_slides_contenido")
  @@index([orden], name: "idx_slides_orden")
  @@map("slides")
}

/// Progreso del estudiante en un contenido
/// Registra el avance y tiempo dedicado a cada lecci√≥n
model ProgresoContenido {
  /// Identificador √∫nico
  id String @id @default(cuid())

  /// ID del estudiante
  estudianteId String @map("estudiante_id")

  /// ID del contenido
  contenidoId String @map("contenido_id")

  /// √çndice del √∫ltimo slide visto (0-based)
  slideActual Int @default(0) @map("slide_actual")

  /// Si complet√≥ todo el contenido
  completado Boolean @default(false)

  /// Tiempo total dedicado en segundos
  tiempoTotalSegundos Int @default(0) @map("tiempo_total_segundos")

  /// Fecha de inicio
  fechaInicio DateTime @default(now()) @map("fecha_inicio")

  /// Fecha de √∫ltima actividad
  ultimaActividad DateTime @updatedAt @map("ultima_actividad")

  /// Fecha de completitud (null si no completado)
  fechaCompletitud DateTime? @map("fecha_completitud")

  /// Relaciones
  estudiante Estudiante @relation(fields: [estudianteId], references: [id], onDelete: Cascade)
  contenido  Contenido  @relation(fields: [contenidoId], references: [id], onDelete: Cascade)

  @@unique([estudianteId, contenidoId])
  @@index([estudianteId], name: "idx_progreso_estudiante")
  @@index([contenidoId], name: "idx_progreso_contenido")
  @@map("progreso_contenidos")
}

/// Modelo para Tiers de suscripci√≥n - Sistema Mateatletas 2026
///
/// Sistema de 3 tiers:
/// - ARCADE: $30k - 1 mundo async, sin docente (entry-level)
/// - ARCADE_PLUS: $60k - 3 mundos async, sin docente (amplitud)
/// - PRO: $75k - 1 mundo async + 1 mundo sync con docente (profundidad)
///
/// Reglas de negocio:
/// - El tier es por estudiante, no por familia
/// - Los descuentos familiares (12%/20%) aplican al total
/// - PRO requiere que mundo async ‚â† mundo sync
model Tier {
  /// Identificador √∫nico del tier
  id             String     @id @default(cuid())
  /// Nombre del tier (ARCADE, ARCADE_PLUS, PRO) - √∫nico
  nombre         TierNombre @unique
  /// Precio mensual en pesos
  precio_mensual Int
  /// Cantidad de mundos async incluidos
  mundos_async   Int
  /// Cantidad de mundos sync (con docente) incluidos
  mundos_sync    Int
  /// Indica si incluye acceso a docente
  tiene_docente  Boolean    @default(false)
  /// Descripci√≥n del tier para UI
  descripcion    String?
  /// Indica si el tier est√° activo para nuevas inscripciones
  activo         Boolean    @default(true)
  /// Orden de visualizaci√≥n (para pricing page)
  orden          Int        @default(0)

  /// Timestamp de creaci√≥n del registro
  createdAt DateTime @default(now())
  /// Timestamp de √∫ltima actualizaci√≥n del registro
  updatedAt DateTime @updatedAt

  @@map("tiers")
}

/// Modelo para docentes (profesores) de la plataforma
/// Representa a los usuarios educadores que dictan clases
model Docente {
  /// Identificador √∫nico del docente
  id                     String          @id @default(cuid())
  /// Email √∫nico del docente - usado para autenticaci√≥n
  email                  String          @unique
  /// Hash bcrypt de la contrase√±a
  password_hash          String
  /// Nombre del docente
  nombre                 String
  /// Apellido del docente
  apellido               String
  /// T√≠tulo profesional (ej: "Profesor de Matem√°tica", "Licenciado en F√≠sica")
  titulo                 String?
  /// Biograf√≠a o descripci√≥n del docente
  bio                    String?
  /// Timestamp de creaci√≥n del registro
  createdAt              DateTime        @default(now())
  /// Timestamp de √∫ltima actualizaci√≥n del registro
  updatedAt              DateTime        @updatedAt
  /// Disponibilidad horaria del docente (ej: {"lunes": ["09:00-12:00", "14:00-18:00"], "martes": ["10:00-13:00"]})
  /// Se almacena como JSON object con d√≠as de la semana como keys
  disponibilidad_horaria Json?
  /// Especialidades del docente (ej: ["√Ålgebra", "Geometr√≠a", "Trigonometr√≠a"])
  /// Se almacena como JSON array de strings
  especialidades         Json?
  /// Estado del docente (activo, inactivo, vacaciones)
  estado                 String          @default("activo")
  /// A√±os de experiencia docente
  experiencia_anos       Int?
  /// Nivel educativo que el docente puede impartir (ej: ["Primaria", "Secundaria", "Universidad"])
  /// Se almacena como JSON array de strings
  nivel_educativo        Json?
  /// Roles asignados al docente (puede ser docente y admin simult√°neamente)
  /// Ejemplo: ["docente", "admin"]
  roles                  Json            @default("[\"docente\"]")
  /// Tel√©fono de contacto (opcional)
  telefono               String?
  /// Fecha del √∫ltimo cambio de contrase√±a
  fecha_ultimo_cambio    DateTime?
  clases                 Clase[]
  claseGrupos            ClaseGrupo[]
  rutasEspecialidad      DocenteRuta[]
  eventos                Evento[]
  notificaciones         Notificacion[]
  puntosOtorgados        PuntoObtenido[] @relation("PuntosOtorgados")

  @@map("docentes")
}

/// Modelo para administradores del sistema
/// Tienen acceso completo al dashboard administrativo
model Admin {
  /// Identificador √∫nico del admin (CUID)
  id                  String    @id @default(cuid())
  /// Email √∫nico del admin - usado para autenticaci√≥n
  email               String    @unique
  /// Hash bcrypt de la contrase√±a - NUNCA se env√≠a al frontend
  password_hash       String
  /// Fecha del √∫ltimo cambio de contrase√±a
  fecha_ultimo_cambio DateTime?
  /// Nombre del admin
  nombre              String
  /// Apellido del admin
  apellido            String
  /// Fecha en que el admin fue creado
  fecha_registro      DateTime  @default(now())
  /// Timestamp de creaci√≥n del registro
  createdAt           DateTime  @default(now())
  /// Timestamp de √∫ltima actualizaci√≥n del registro
  updatedAt           DateTime  @updatedAt
  /// DNI del admin (opcional)
  dni                 String?
  /// Roles asignados al admin (puede ser admin y docente simult√°neamente)
  /// Ejemplo: ["admin", "docente"]
  roles               Json      @default("[\"admin\"]")
  /// Tel√©fono del admin (opcional)
  telefono            String?
  /// Secret TOTP para MFA (Multi-Factor Authentication)
  /// Guardado encriptado en DB para seguridad
  mfa_secret          String?
  /// Indica si MFA est√° habilitado para este admin
  mfa_enabled         Boolean   @default(false)
  /// C√≥digos de backup para MFA (hasheados con bcrypt)
  /// Array de strings - cada c√≥digo es de un solo uso
  mfa_backup_codes    String[]  @default([])

  /// SANDBOX: Contenidos educativos creados por este admin
  contenidosCreados Contenido[]

  @@map("admins")
}

/// Registro de intentos de login para seguridad y rate limiting
/// Almacena tanto intentos exitosos como fallidos para auditor√≠a
model LoginAttempt {
  /// Identificador √∫nico del intento
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  /// Email usado en el intento de login
  email     String   @db.VarChar(255)
  /// Direcci√≥n IP desde donde se hizo el intento
  ip        String   @db.VarChar(45)
  /// Si el intento fue exitoso o no
  success   Boolean  @default(false)
  /// Timestamp del intento
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([email], name: "idx_login_attempts_email")
  @@index([createdAt], name: "idx_login_attempts_created_at")
  @@map("login_attempts")
}

/// Token para recuperaci√≥n de contrase√±a (olvid√© mi contrase√±a)
/// Los tokens son de un solo uso y expiran en 1 hora
model PasswordResetToken {
  /// Identificador √∫nico del token
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  /// Email del usuario que solicita el reset
  email     String   @db.VarChar(255)
  /// Token hasheado (SHA256) - nunca almacenar en texto plano
  token     String   @db.VarChar(64)
  /// Tipo de usuario (tutor, docente, admin, estudiante)
  user_type String   @db.VarChar(20)
  /// Timestamp de expiraci√≥n (1 hora desde creaci√≥n)
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  /// Si el token ya fue usado
  used      Boolean  @default(false)
  /// Timestamp de creaci√≥n
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([email], name: "idx_password_reset_email")
  @@index([token], name: "idx_password_reset_token")
  @@index([expiresAt], name: "idx_password_reset_expires")
  @@map("password_reset_tokens")
}

/// Sesiones activas de refresh tokens (para gesti√≥n de sesiones)
/// Permite ver y revocar sesiones desde cualquier dispositivo
model RefreshTokenSession {
  /// Identificador √∫nico (JTI del refresh token)
  id            String   @id @db.VarChar(36)
  /// ID del usuario
  user_id       String   @db.Uuid
  /// Tipo de usuario (tutor, docente, admin, estudiante)
  user_type     String   @db.VarChar(20)
  /// Direcci√≥n IP desde donde se cre√≥ la sesi√≥n
  ip_address    String?  @db.VarChar(45)
  /// User agent del navegador/app
  user_agent    String?  @db.VarChar(500)
  /// Timestamp de creaci√≥n de la sesi√≥n
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  /// Timestamp de √∫ltima actividad (renovaci√≥n de token)
  lastUsedAt    DateTime @default(now()) @map("last_used_at") @db.Timestamptz
  /// Timestamp de expiraci√≥n
  expiresAt     DateTime @map("expires_at") @db.Timestamptz
  /// Si la sesi√≥n fue revocada manualmente
  revoked       Boolean  @default(false)
  /// Raz√≥n de revocaci√≥n (logout, password_change, security, admin_action)
  revokedReason String?  @map("revoked_reason") @db.VarChar(50)

  @@index([user_id], name: "idx_refresh_session_user")
  @@index([expiresAt], name: "idx_refresh_session_expires")
  @@map("refresh_token_sessions")
}

/// Modelo para productos del cat√°logo
/// Representa los productos que se pueden comprar: suscripciones, cursos, recursos
///
/// TODO: V2 - Expandir Producto para tienda virtual
/// - Agregar tipos: DIGITAL, FISICO, EVENTO
/// - Campos: archivo_url, stock, cupo_maximo, fecha_evento, requiere_envio
/// - Frontend admin para crear productos
/// - Cat√°logo p√∫blico para comprar
model Producto {
  /// Identificador √∫nico del producto
  id                      String               @id @default(cuid())
  /// Nombre del producto (ej: "Suscripci√≥n Mensual", "Curso de √Ålgebra")
  nombre                  String
  /// Descripci√≥n detallada del producto
  descripcion             String?
  /// Precio del producto en pesos (formato decimal para precisi√≥n)
  precio                  Decimal              @db.Decimal(10, 2)
  /// Tipo de producto (Suscripcion, Curso, RecursoDigital)
  tipo                    TipoProducto
  /// Indica si el producto est√° activo y disponible para compra
  activo                  Boolean              @default(true)
  /// Fecha de inicio del curso (solo para tipo Curso)
  fecha_inicio            DateTime?
  /// Fecha de finalizaci√≥n del curso (solo para tipo Curso)
  fecha_fin               DateTime?
  /// Cupo m√°ximo de estudiantes (solo para tipo Curso)
  cupo_maximo             Int?
  /// Duraci√≥n en meses de la suscripci√≥n (1=mensual, 12=anual, etc.)
  duracion_meses          Int?                 @default(1)
  /// Timestamp de creaci√≥n del registro
  createdAt               DateTime             @default(now())
  /// Timestamp de √∫ltima actualizaci√≥n del registro
  updatedAt               DateTime             @updatedAt
  clases                  Clase[]
  inscripciones_mensuales InscripcionMensual[]

  @@map("productos")
}

// [ELIMINADO] Membresia e InscripcionCurso - sistema legacy reemplazado por Suscripciones PreApproval

/// Modelo para clases programadas
/// Representa una clase en vivo programada por un admin
model Clase {
  /// Identificador √∫nico de la clase
  id                String             @id @default(cuid())
  /// ID del docente asignado a la clase
  docente_id        String
  /// Fecha y hora de inicio de la clase
  fecha_hora_inicio DateTime
  /// Duraci√≥n de la clase en minutos
  duracion_minutos  Int
  /// Estado de la clase (Programada, Cancelada)
  estado            EstadoClase        @default(Programada)
  /// Cupo m√°ximo de estudiantes
  cupos_maximo      Int
  /// Cupos ocupados actualmente
  cupos_ocupados    Int                @default(0)
  /// ID del producto curso (opcional - si null es clase de suscripci√≥n general)
  /// Si tiene valor, solo estudiantes con InscripcionCurso activa pueden reservar
  producto_id       String?
  /// Timestamp de creaci√≥n del registro
  createdAt         DateTime           @default(now())
  /// Timestamp de √∫ltima actualizaci√≥n del registro
  updatedAt         DateTime           @updatedAt
  /// Descripci√≥n o grupo de la clase (ej: "Ni√±os 6-7 a√±os", "Grupo A", "Preparaci√≥n olimpiadas")
  descripcion       String?
  /// Nombre o tema de la clase (ej: "Godot", "Scratch", "Preparaci√≥n Olimpiadas")
  nombre            String
  /// ID del sector (Matem√°tica o Programaci√≥n) - OPCIONAL
  sector_id         String?
  alertas           Alerta[]
  asistencias       Asistencia[]
  docente           Docente            @relation(fields: [docente_id], references: [id])
  producto          Producto?          @relation(fields: [producto_id], references: [id])
  sector            Sector?            @relation(fields: [sector_id], references: [id])
  eventos           Evento[]
  inscripciones     InscripcionClase[]
  puntosObtenidos   PuntoObtenido[]

  @@index([docente_id])
  @@index([fecha_hora_inicio])
  @@index([estado])
  @@index([producto_id])
  @@map("clases")
}

/// Modelo para Grupos Pedag√≥gicos
/// Representa los niveles educativos o categor√≠as pedag√≥gicas (B1, B2, B3, A1, etc.)
/// Los grupos son conceptos estables que agrupan contenido pedag√≥gico del mismo nivel
model Grupo {
  /// Identificador √∫nico del grupo
  id String @id @default(cuid())

  /// C√≥digo del grupo (ej: "B1", "B2", "B3", "A1", "OLIMP")
  codigo String @unique

  /// Nombre descriptivo del grupo
  nombre String // "B√°sico 1", "B√°sico 2", "Avanzado 1"

  /// Descripci√≥n del grupo y nivel educativo
  descripcion String?

  /// Rango de edad sugerido
  edad_minima Int?
  edad_maxima Int?

  /// Sector al que pertenece (Matem√°tica o Programaci√≥n)
  sector_id String?

  /// Link de Google Meet para las clases de este grupo
  link_meet String?

  /// Indica si el grupo est√° activo
  activo Boolean @default(true)

  /// Timestamp de creaci√≥n
  createdAt DateTime @default(now())

  /// Timestamp de √∫ltima actualizaci√≥n
  updatedAt DateTime @updatedAt

  /// Relaciones
  sector Sector? @relation(fields: [sector_id], references: [id])

  /// Comisiones (instancias operativas) de este grupo
  comisiones ClaseGrupo[]

  @@index([codigo])
  @@index([activo])
  @@map("grupos")
}

/// Modelo para grupos de clases recurrentes (ahora llamado Comision conceptualmente)
/// Representa un grupo estable de estudiantes que se re√∫ne semanalmente
/// Ejemplo: "GRUPO B1 - Matem√°tica - Lunes 19:30"
model ClaseGrupo {
  /// Identificador √∫nico del grupo
  id String @id @default(cuid())

  /// C√≥digo del grupo pedag√≥gico (puede repetirse, ej: "B2" para varios horarios)
  /// Se usa principalmente para identificaci√≥n visual, no es unique
  codigo String

  /// Nombre descriptivo del grupo (este s√≠ es √∫nico por instancia)
  nombre String @unique

  /// Tipo de clase grupo
  tipo TipoClaseGrupo @default(GRUPO_REGULAR)

  /// D√≠a de la semana en que se re√∫ne
  dia_semana DiaSemana

  /// Hora de inicio en formato HH:MM (ej: "19:30")
  hora_inicio String

  /// Hora de fin en formato HH:MM (ej: "21:00")
  hora_fin String

  /// Fecha de inicio de vigencia del grupo
  fecha_inicio DateTime

  /// Fecha de fin de vigencia del grupo
  /// Para GRUPO_REGULAR: siempre 15 de diciembre del a√±o
  /// Para CURSO_TEMPORAL: fecha espec√≠fica definida por admin
  fecha_fin DateTime

  /// A√±o lectivo al que pertenece (ej: 2025)
  anio_lectivo Int

  /// Cupo m√°ximo de estudiantes
  cupo_maximo Int @default(15)

  /// ID del grupo pedag√≥gico al que pertenece (B1, B2, B3, etc.)
  grupo_id String

  /// ID del docente asignado
  docente_id String

  /// ID del sector (Matem√°tica o Programaci√≥n)
  sector_id String?

  /// Nivel o descripci√≥n (ej: "6 y 7 a√±os", "Preparaci√≥n olimpiadas")
  nivel String?

  /// Indica si el grupo est√° activo
  activo Boolean @default(true)

  /// Timestamp de creaci√≥n
  createdAt DateTime @default(now())

  /// Timestamp de √∫ltima actualizaci√≥n
  updatedAt DateTime @updatedAt

  /// Relaciones
  grupo   Grupo   @relation(fields: [grupo_id], references: [id])
  docente Docente @relation(fields: [docente_id], references: [id])
  sector  Sector? @relation(fields: [sector_id], references: [id])

  /// Estudiantes inscritos en el grupo
  inscripciones InscripcionClaseGrupo[]

  /// Registros de asistencia del grupo
  asistencias AsistenciaClaseGrupo[]

  @@index([docente_id])
  @@index([dia_semana])
  @@index([fecha_inicio, fecha_fin])
  @@index([anio_lectivo])
  @@index([activo])
  @@map("clase_grupos")
}

/// Inscripci√≥n de un estudiante a un ClaseGrupo
/// Relaci√≥n muchos-a-muchos entre Estudiante y ClaseGrupo
model InscripcionClaseGrupo {
  /// Identificador √∫nico
  id String @id @default(cuid())

  /// ID del grupo de clase
  clase_grupo_id String

  /// ID del estudiante inscrito
  estudiante_id String

  /// ID del tutor del estudiante
  tutor_id String

  /// Fecha de inscripci√≥n al grupo
  fecha_inscripcion DateTime @default(now())

  /// Fecha de baja del grupo (si se retira antes del fin)
  fecha_baja DateTime?

  /// Observaciones
  observaciones String?

  /// Timestamp de creaci√≥n
  createdAt DateTime @default(now())

  /// Timestamp de √∫ltima actualizaci√≥n
  updatedAt DateTime @updatedAt

  /// Relaciones
  claseGrupo ClaseGrupo @relation(fields: [clase_grupo_id], references: [id], onDelete: Cascade)
  estudiante Estudiante @relation(fields: [estudiante_id], references: [id], onDelete: Cascade)
  tutor      Tutor      @relation(fields: [tutor_id], references: [id])

  @@unique([clase_grupo_id, estudiante_id])
  @@index([estudiante_id])
  @@index([tutor_id])
  @@index([clase_grupo_id])
  @@map("inscripciones_clase_grupo")
}

/// Registro de asistencia a una sesi√≥n espec√≠fica de un ClaseGrupo
/// Se crea cuando el docente marca asistencia un d√≠a espec√≠fico
model AsistenciaClaseGrupo {
  /// Identificador √∫nico
  id String @id @default(cuid())

  /// ID del grupo de clase
  clase_grupo_id String

  /// ID del estudiante
  estudiante_id String

  /// Fecha espec√≠fica de la clase (ej: "2025-10-21" para el lunes 21/10)
  fecha DateTime

  /// Estado de asistencia
  estado EstadoAsistencia

  /// Observaciones del docente sobre el estudiante en esta clase
  observaciones String?

  /// Calificaci√≥n o feedback cualitativo (opcional)
  feedback String?

  /// Timestamp de creaci√≥n
  createdAt DateTime @default(now())

  /// Timestamp de √∫ltima actualizaci√≥n
  updatedAt DateTime @updatedAt

  /// Relaciones
  claseGrupo ClaseGrupo @relation(fields: [clase_grupo_id], references: [id], onDelete: Cascade)
  estudiante Estudiante @relation(fields: [estudiante_id], references: [id], onDelete: Cascade)

  @@unique([clase_grupo_id, estudiante_id, fecha])
  @@index([clase_grupo_id])
  @@index([estudiante_id])
  @@index([fecha])
  // √çndice de performance para filtros por estado de asistencia
  @@index([estado], name: "idx_asistencias_estado")
  @@map("asistencias_clase_grupo")
}

/// Modelo para inscripciones a clases (reservas)
/// Vincula un estudiante con una clase espec√≠fica
model InscripcionClase {
  /// Identificador √∫nico de la inscripci√≥n
  id                String     @id @default(cuid())
  /// ID de la clase
  clase_id          String
  /// ID del estudiante inscrito
  estudiante_id     String
  /// ID del tutor que realiz√≥ la reserva
  tutor_id          String
  /// Fecha de la inscripci√≥n
  fecha_inscripcion DateTime   @default(now())
  /// Observaciones o notas sobre la inscripci√≥n
  observaciones     String?
  /// Timestamp de creaci√≥n del registro
  createdAt         DateTime   @default(now())
  /// Timestamp de √∫ltima actualizaci√≥n del registro
  updatedAt         DateTime   @updatedAt
  clase             Clase      @relation(fields: [clase_id], references: [id], onDelete: Cascade)
  estudiante        Estudiante @relation(fields: [estudiante_id], references: [id], onDelete: Cascade)
  tutor             Tutor      @relation(fields: [tutor_id], references: [id])

  @@unique([clase_id, estudiante_id])
  @@index([estudiante_id])
  @@index([tutor_id])
  @@map("inscripciones_clase")
}

/// Modelo para registro de asistencia
/// Registra la asistencia y feedback del docente despu√©s de la clase
model Asistencia {
  /// Identificador √∫nico del registro de asistencia
  id               String           @id @default(cuid())
  /// ID de la clase
  clase_id         String
  /// ID del estudiante
  estudiante_id    String
  /// Estado de asistencia (Presente, Ausente, Justificado)
  estado           EstadoAsistencia
  /// Observaciones del docente sobre el estudiante en esta clase
  observaciones    String?
  /// Puntos otorgados al estudiante en esta clase (para gamificaci√≥n)
  puntos_otorgados Int              @default(0)
  /// Fecha y hora del registro de asistencia
  fecha_registro   DateTime         @default(now())
  /// Timestamp de creaci√≥n del registro
  createdAt        DateTime         @default(now())
  /// Timestamp de √∫ltima actualizaci√≥n del registro
  updatedAt        DateTime         @updatedAt
  clase            Clase            @relation(fields: [clase_id], references: [id], onDelete: Cascade)
  estudiante       Estudiante       @relation(fields: [estudiante_id], references: [id], onDelete: Cascade)

  @@unique([clase_id, estudiante_id])
  @@index([estudiante_id])
  @@index([estado])
  @@index([clase_id, estudiante_id, estado])
  @@map("asistencias")
}

/// Modelo para alertas administrativas generadas desde observaciones de docentes
/// Permite al admin detectar y resolver situaciones que requieren atenci√≥n
model Alerta {
  /// Identificador √∫nico de la alerta
  id            String     @id @default(cuid())
  /// ID del estudiante relacionado con la alerta
  estudiante_id String
  /// ID de la clase donde se gener√≥ la alerta
  clase_id      String
  /// Descripci√≥n de la alerta (observaciones del docente)
  descripcion   String
  /// Fecha de creaci√≥n de la alerta
  fecha         DateTime   @default(now())
  /// Indica si la alerta ha sido resuelta
  resuelta      Boolean    @default(false)
  /// Timestamp de creaci√≥n del registro
  createdAt     DateTime   @default(now())
  /// Timestamp de √∫ltima actualizaci√≥n del registro
  updatedAt     DateTime   @updatedAt
  clase         Clase      @relation(fields: [clase_id], references: [id], onDelete: Cascade)
  estudiante    Estudiante @relation(fields: [estudiante_id], references: [id], onDelete: Cascade)

  @@index([estudiante_id])
  @@index([resuelta])
  @@index([fecha])
  @@map("alertas")
}

/// Modelo para registro de puntos obtenidos (tabla transaccional)
/// Cada registro representa un evento donde un estudiante gan√≥ puntos
model PuntoObtenido {
  /// Identificador √∫nico del registro
  id             String     @id @default(cuid())
  /// ID del estudiante que obtuvo los puntos
  estudiante_id  String
  /// ID del docente que otorg√≥ los puntos
  docente_id     String
  /// Tipo de acci√≥n que gener√≥ los puntos (reemplaza FK a AccionPuntuable)
  /// Ejemplos: "ASISTENCIA", "PARTICIPACION", "LOGRO", "BONUS"
  tipo_accion    String     @default("ASISTENCIA")
  /// ID de la clase donde se ganaron los puntos (opcional)
  clase_id       String?
  /// Cantidad de puntos otorgados (se guarda para preservar historial)
  puntos         Int
  /// Contexto o raz√≥n adicional (opcional)
  contexto       String?
  /// Fecha y hora en que se otorgaron los puntos
  fecha_otorgado DateTime   @default(now())
  /// Timestamp de creaci√≥n del registro
  createdAt      DateTime   @default(now())
  /// Timestamp de √∫ltima actualizaci√≥n del registro
  updatedAt      DateTime   @updatedAt
  clase          Clase?     @relation(fields: [clase_id], references: [id])
  docente        Docente    @relation("PuntosOtorgados", fields: [docente_id], references: [id])
  estudiante     Estudiante @relation(fields: [estudiante_id], references: [id], onDelete: Cascade)

  @@index([estudiante_id])
  @@index([docente_id])
  @@index([tipo_accion])
  @@index([fecha_otorgado])
  @@map("puntos_obtenidos")
}

// [ELIMINADO] Modulo, Leccion, ProgresoLeccion - sistema de contenido legacy
// Reemplazado por nuevo sistema: Area ‚Üí SubArea ‚Üí Microleccion (FASE 2)

/// Sistema de notificaciones para docentes
/// Permite notificar eventos importantes como clases pr√≥ximas, alertas de estudiantes, etc.
model Notificacion {
  /// Identificador √∫nico de la notificaci√≥n
  id         String           @id @default(cuid())
  /// Tipo de notificaci√≥n
  tipo       TipoNotificacion
  /// T√≠tulo de la notificaci√≥n
  titulo     String
  /// Mensaje descriptivo de la notificaci√≥n
  mensaje    String
  /// Indica si la notificaci√≥n ha sido le√≠da
  leida      Boolean          @default(false)
  /// ID del docente al que pertenece la notificaci√≥n
  docente_id String
  /// Metadata adicional en formato JSON (clase_id, estudiante_id, etc)
  metadata   Json?
  /// Timestamp de creaci√≥n de la notificaci√≥n
  createdAt  DateTime         @default(now())
  docente    Docente          @relation(fields: [docente_id], references: [id], onDelete: Cascade)

  @@index([docente_id, leida])
  @@index([docente_id, createdAt])
  @@map("notificaciones")
}

/// Eventos del calendario del docente
/// Modelo base polim√≥rfico: puede ser Clase, Tarea, Recordatorio o Nota
model Evento {
  /// Identificador √∫nico del evento
  id             String        @id @default(cuid())
  /// T√≠tulo del evento
  titulo         String
  /// Descripci√≥n detallada del evento
  descripcion    String?
  /// Tipo de evento (CLASE, TAREA, RECORDATORIO, NOTA)
  tipo           TipoEvento
  /// Fecha y hora de inicio del evento
  fecha_inicio   DateTime
  /// Fecha y hora de fin del evento
  fecha_fin      DateTime
  /// Indica si el evento dura todo el d√≠a
  es_todo_el_dia Boolean       @default(false)
  /// ID del docente al que pertenece el evento
  docente_id     String
  /// ID de la clase relacionada (para reprogramaci√≥n/recuperaci√≥n)
  clase_id       String?
  /// Timestamp de creaci√≥n del evento
  createdAt      DateTime      @default(now())
  /// Timestamp de √∫ltima actualizaci√≥n del evento
  updatedAt      DateTime      @updatedAt
  clase          Clase?        @relation(fields: [clase_id], references: [id])
  docente        Docente       @relation(fields: [docente_id], references: [id], onDelete: Cascade)
  nota           Nota?
  recordatorio   Recordatorio?
  tarea          Tarea?

  @@index([docente_id, fecha_inicio])
  @@index([tipo])
  @@index([docente_id, tipo])
  @@index([clase_id])
  @@map("eventos")
}

/// Tarea administrativa/pedag√≥gica del docente
/// Extensi√≥n del modelo Evento para tareas con funcionalidad completa
model Tarea {
  /// Identificador √∫nico de la tarea
  id                        String         @id @default(cuid())
  /// ID del evento base asociado
  evento_id                 String         @unique
  /// Estado actual de la tarea
  estado                    EstadoTarea    @default(PENDIENTE)
  /// Nivel de prioridad de la tarea
  prioridad                 PrioridadTarea @default(MEDIA)
  /// Porcentaje de completitud (0-100)
  porcentaje_completado     Int            @default(0)
  /// Categor√≠a personalizada de la tarea (ej: "Planificaci√≥n", "Evaluaci√≥n")
  categoria                 String?
  /// Etiquetas para organizaci√≥n (array de strings)
  etiquetas                 String[]
  /// Subtareas en formato JSON
  /// Estructura: [{id: string, titulo: string, completada: boolean, orden: number}]
  subtareas                 Json           @default("[]")
  /// Archivos adjuntos en formato JSON
  /// Estructura: [{id: string, nombre: string, url: string, tipo: string, tama√±o: number}]
  archivos                  Json           @default("[]")
  /// ID de clase relacionada (opcional)
  clase_relacionada_id      String?
  /// ID de estudiante relacionado (opcional)
  estudiante_relacionado_id String?
  /// Tiempo estimado para completar en minutos
  tiempo_estimado_minutos   Int?
  /// Tiempo real invertido en minutos
  tiempo_real_minutos       Int?
  /// Configuraci√≥n de recurrencia en formato JSON
  /// Estructura: {tipo: 'DIARIA'|'SEMANAL'|'MENSUAL', intervalo: number, dias_semana: number[], fecha_fin: string, excepciones: string[]}
  recurrencia               Json?
  /// Recordatorios configurados en formato JSON
  /// Estructura: [{minutos_antes: number, enviado: boolean}]
  recordatorios             Json           @default("[]")
  /// Fecha de completitud
  completedAt               DateTime?
  evento                    Evento         @relation(fields: [evento_id], references: [id], onDelete: Cascade)

  @@index([estado])
  @@index([prioridad])
  @@index([categoria])
  @@map("tareas")
}

/// Recordatorio simple para el docente
/// Extensi√≥n del modelo Evento para recordatorios b√°sicos
model Recordatorio {
  /// Identificador √∫nico del recordatorio
  id         String  @id @default(cuid())
  /// ID del evento base asociado
  evento_id  String  @unique
  /// Indica si el recordatorio fue completado/marcado
  completado Boolean @default(false)
  /// Color personalizado del recordatorio (formato hex)
  color      String  @default("#6366f1")
  evento     Evento  @relation(fields: [evento_id], references: [id], onDelete: Cascade)

  @@map("recordatorios")
}

/// Nota de texto largo para el docente
/// Extensi√≥n del modelo Evento para notas/apuntes
model Nota {
  /// Identificador √∫nico de la nota
  id        String  @id @default(cuid())
  /// ID del evento base asociado
  evento_id String  @unique
  /// Contenido de la nota (texto largo)
  contenido String
  /// Categor√≠a de la nota (opcional)
  categoria String?
  /// Color personalizado de la nota (formato hex)
  color     String  @default("#8b5cf6")
  evento    Evento  @relation(fields: [evento_id], references: [id], onDelete: Cascade)

  @@index([categoria])
  @@map("notas")
}

/// Modelo para sectores de trabajo (Matem√°tica, Programaci√≥n, etc.)
/// Permite organizar las especialidades en categor√≠as principales
model Sector {
  /// Identificador √∫nico del sector
  id          String             @id @default(cuid())
  /// Nombre del sector (ej: "Matem√°tica", "Programaci√≥n")
  nombre      String             @unique
  /// Descripci√≥n del sector
  descripcion String?
  /// Color hex para UI (ej: "#FF5733")
  color       String             @default("#6366F1")
  /// Icono o emoji para UI (ej: "üìê", "üíª")
  icono       String             @default("üìö")
  /// Indica si el sector est√° activo
  activo      Boolean            @default(true)
  /// Timestamp de creaci√≥n del registro
  createdAt   DateTime           @default(now())
  /// Timestamp de √∫ltima actualizaci√≥n del registro
  updatedAt   DateTime           @updatedAt
  clases      Clase[]
  claseGrupos ClaseGrupo[]
  grupos      Grupo[]
  docentes    DocenteRuta[]
  /// Relaci√≥n uno-a-muchos con estudiantes
  estudiantes Estudiante[]       @relation("EstudianteSectorLegacy")
  rutas       RutaEspecialidad[]

  @@map("sectores")
}

/// Modelo para rutas de especialidad personalizadas dentro de cada sector
/// Ejemplos: "Roblox", "Scratch" (Programaci√≥n), "Base-Progresivo", "L√≥gico-Desafiante" (Matem√°tica)
model RutaEspecialidad {
  /// Identificador √∫nico de la ruta
  id          String        @id @default(cuid())
  /// Nombre de la ruta (ej: "Roblox", "Base-Progresivo")
  nombre      String
  /// Descripci√≥n de la ruta
  descripcion String?
  /// ID del sector al que pertenece
  sectorId    String
  /// Indica si la ruta est√° activa
  activo      Boolean       @default(true)
  /// Timestamp de creaci√≥n del registro
  createdAt   DateTime      @default(now())
  /// Timestamp de √∫ltima actualizaci√≥n del registro
  updatedAt   DateTime      @updatedAt
  docentes    DocenteRuta[]
  sector      Sector        @relation(fields: [sectorId], references: [id], onDelete: Cascade)

  @@unique([sectorId, nombre])
  @@index([sectorId])
  @@map("rutas_especialidad")
}

/// Modelo de relaci√≥n muchos-a-muchos entre Docentes y Rutas de Especialidad
/// Un docente puede trabajar en m√∫ltiples rutas y sectores
model DocenteRuta {
  /// Identificador √∫nico de la relaci√≥n
  id         String           @id @default(cuid())
  /// ID del docente
  docenteId  String
  /// ID de la ruta de especialidad
  rutaId     String
  /// ID del sector (desnormalizado para queries m√°s r√°pidas)
  sectorId   String
  /// Fecha de asignaci√≥n
  asignadoEn DateTime         @default(now())
  docente    Docente          @relation(fields: [docenteId], references: [id], onDelete: Cascade)
  ruta       RutaEspecialidad @relation(fields: [rutaId], references: [id], onDelete: Cascade)
  sector     Sector           @relation(fields: [sectorId], references: [id], onDelete: Cascade)

  @@unique([docenteId, rutaId])
  @@index([docenteId])
  @@index([rutaId])
  @@index([sectorId])
  @@map("docentes_rutas")
}

/// Enum para tipos de productos disponibles
enum TipoProducto {
  Suscripcion
  Curso
  RecursoDigital
}

/// Enum para tipos de casa (sistema 2026)
/// Las casas agrupan estudiantes por rango de edad
enum CasaTipo {
  QUANTUM // 6-9 a√±os - Exploradores
  VERTEX // 10-12 a√±os - Constructores
  PULSAR // 13-17 a√±os - Dominadores

  @@map("casa_tipo")
}

/// Enum para tipos de mundo STEAM (2026)
/// Los mundos representan las 3 √°reas de conocimiento principales
enum MundoTipo {
  MATEMATICA // Mundo de matem√°ticas - naranja
  PROGRAMACION // Mundo de programaci√≥n - verde
  CIENCIAS // Mundo de ciencias - azul

  @@map("mundo_tipo")
}

/// Estado del contenido educativo en el flujo de publicaci√≥n
/// BORRADOR -> PUBLICADO -> ARCHIVADO
enum EstadoContenido {
  BORRADOR // Creado, editable, no visible para estudiantes
  PUBLICADO // Visible para estudiantes de la casa correspondiente
  ARCHIVADO // Oculto, pero preservado para historial

  @@map("estado_contenido")
}

/// Enum para estado del onboarding del estudiante (2026)
/// Flujo: PENDIENTE -> SELECCION_MUNDOS -> TEST_UBICACION -> CONFIRMACION_CASA -> CREACION_AVATAR -> COMPLETADO
enum OnboardingEstado {
  PENDIENTE // Reci√©n inscrito, no ha empezado
  SELECCION_MUNDOS // Eligiendo mundos seg√∫n tier
  TEST_UBICACION // Haciendo test diagn√≥stico
  CONFIRMACION_CASA // Viendo casa asignada
  CREACION_AVATAR // Personalizando avatar 2D
  COMPLETADO // Listo para usar la plataforma

  @@map("onboarding_estado")
}

/// Enum para tipos de tier de suscripci√≥n (2026)
/// Define los niveles de acceso a la plataforma STEAM
enum TierNombre {
  STEAM_LIBROS // $40k - Plataforma completa (Mate + Progra + Ciencias)
  STEAM_ASINCRONICO // $65k - Todo + clases grabadas
  STEAM_SINCRONICO // $95k - Todo + clases en vivo con docente

  @@map("tier_nombre")
}

// [ELIMINADO] EstadoMembresia y EstadoInscripcionCurso - enums de sistema legacy

/// Enum para estados de clase
enum EstadoClase {
  Programada
  Cancelada
}

/// Enum para estados de asistencia
enum EstadoAsistencia {
  Presente
  Ausente
  Justificado
}

// [ELIMINADO] TipoContenido - usado por modelo Leccion eliminado

/// Tipos de notificaciones disponibles
enum TipoNotificacion {
  ClaseProxima
  AsistenciaPendiente
  EstudianteAlerta
  ClaseCancelada
  LogroEstudiante
  Recordatorio
  General

  @@map("tipo_notificacion")
}

/// Tipos de eventos disponibles en el calendario
enum TipoEvento {
  CLASE
  TAREA
  RECORDATORIO
  NOTA

  @@map("tipo_evento")
}

/// Estados de una tarea
enum EstadoTarea {
  PENDIENTE
  EN_PROGRESO
  COMPLETADA
  CANCELADA

  @@map("estado_tarea")
}

/// Niveles de prioridad para tareas
enum PrioridadTarea {
  BAJA
  MEDIA
  ALTA
  URGENTE

  @@map("prioridad_tarea")
}

// ============================================================================
// SISTEMA DE PAGOS Y CONTABILIDAD
// ============================================================================

/// Configuraci√≥n global de precios (Tabla singleton)
/// Solo existe UN registro con id="singleton"
/// Sistema de Tiers STEAM 2026: STEAM_LIBROS, STEAM_ASINCRONICO, STEAM_SINCRONICO
model ConfiguracionPrecios {
  /// ID fijo "singleton" para garantizar un solo registro
  id String @id @default("singleton")

  /// Precios por Tier STEAM (Sistema 2026)
  precio_steam_libros      Decimal @default(40000) @db.Decimal(10, 2)
  precio_steam_asincronico Decimal @default(65000) @db.Decimal(10, 2)
  precio_steam_sincronico  Decimal @default(95000) @db.Decimal(10, 2)

  /// Descuento familiar simplificado
  descuento_segundo_hermano Decimal @default(10) @db.Decimal(5, 2) // 10% para 2do hermano en adelante

  /// Configuraci√≥n de notificaciones
  dia_vencimiento         Int     @default(15)
  dias_antes_recordatorio Int     @default(5)
  notificaciones_activas  Boolean @default(true)

  /// Metadata
  actualizado_por_admin_id String?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  /// Relaciones
  historial HistorialCambioPrecios[]

  @@map("configuracion_precios")
}

/// Historial de cambios en la configuraci√≥n de precios
/// Auditor√≠a completa de modificaciones
model HistorialCambioPrecios {
  /// Identificador √∫nico del cambio
  id String @id @default(cuid())

  /// Referencia a la configuraci√≥n
  configuracion_id String

  /// Valores antes y despu√©s del cambio (JSON flexible)
  valores_anteriores Json
  valores_nuevos     Json

  /// Metadata del cambio
  motivo_cambio String?
  admin_id      String
  fecha_cambio  DateTime @default(now())

  /// Relaciones
  configuracion ConfiguracionPrecios @relation(fields: [configuracion_id], references: [id])

  @@index([configuracion_id])
  @@index([fecha_cambio])
  @@map("historial_cambio_precios")
}

/// Inscripci√≥n mensual de un estudiante a un producto
/// Reemplaza el concepto de "reserva" por facturaci√≥n mensual
model InscripcionMensual {
  /// Identificador √∫nico
  id String @id @default(cuid())

  /// Relaciones principales
  estudiante_id String
  producto_id   String
  tutor_id      String

  /// Per√≠odo de facturaci√≥n
  anio    Int
  mes     Int // 1-12
  periodo String // "2025-01" para facilitar queries

  /// C√°lculo de precios (guardado para historial)
  precio_base        Decimal @db.Decimal(10, 2)
  descuento_aplicado Decimal @default(0) @db.Decimal(10, 2)
  precio_final       Decimal @db.Decimal(10, 2)

  /// Metadata del c√°lculo
  tipo_descuento  TipoDescuento
  detalle_calculo String // Explicaci√≥n del c√°lculo aplicado

  /// Estado de pago
  estado_pago       EstadoPago @default(Pendiente)
  fecha_vencimiento DateTime? // Fecha l√≠mite de pago
  fecha_pago        DateTime?
  metodo_pago       String? // "Efectivo", "Transferencia", "MercadoPago"
  comprobante_url   String? // URL del comprobante subido
  observaciones     String?

  /// Auditor√≠a
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// Relaciones
  estudiante Estudiante @relation(fields: [estudiante_id], references: [id], onDelete: Cascade)
  producto   Producto   @relation(fields: [producto_id], references: [id])
  tutor      Tutor      @relation(fields: [tutor_id], references: [id])

  @@unique([estudiante_id, producto_id, periodo])
  @@index([tutor_id, periodo])
  @@index([estado_pago])
  @@index([periodo])
  @@map("inscripciones_mensuales")
}

// [ELIMINADO] modelo Beca - sistema no implementado

// ============================================================================
// ENUMS DEL SISTEMA DE PAGOS
// ============================================================================

/// Tipos de descuento aplicables
enum TipoDescuento {
  NINGUNO
  HERMANO_2 // 12% descuento segundo hermano
  HERMANO_3_MAS // 20% descuento tercer hermano en adelante

  @@map("tipo_descuento")
}

/// Estados del pago
enum EstadoPago {
  Pendiente
  Pagado
  Vencido
  Parcial

  @@map("estado_pago")
}

/// Tipo de clase grupo
enum TipoClaseGrupo {
  GRUPO_REGULAR // Clase permanente del a√±o lectivo (finaliza 15/dic)
  CURSO_TEMPORAL // Curso con fecha de fin espec√≠fica

  @@map("tipo_clase_grupo")
}

/// D√≠a de la semana para clases recurrentes
enum DiaSemana {
  LUNES
  MARTES
  MIERCOLES
  JUEVES
  VIERNES
  SABADO
  DOMINGO

  @@map("dia_semana")
}

// ============================================================================
// SISTEMA DE GAMIFICACI√ìN (XP y Progresi√≥n)
// ============================================================================

/// Recursos del estudiante (XP y progresi√≥n)
/// Tabla que centraliza el XP y progresi√≥n del estudiante
model RecursosEstudiante {
  /// Identificador √∫nico
  id String @id @default(cuid())

  /// ID del estudiante
  estudiante_id String @unique

  /// XP total acumulado (Experience Points)
  /// Se usa para niveles, desaf√≠os, progresi√≥n
  xp_total Int @default(0)

  /// √öltima actualizaci√≥n de recursos
  ultima_actualizacion DateTime @updatedAt

  /// Timestamp de creaci√≥n
  createdAt DateTime @default(now())

  /// Timestamp de √∫ltima actualizaci√≥n
  updatedAt DateTime @updatedAt

  /// Relaciones
  estudiante    Estudiante           @relation(fields: [estudiante_id], references: [id], onDelete: Cascade)
  transacciones TransaccionRecurso[]

  @@index([estudiante_id])
  @@map("recursos_estudiante")
}

/// Transacciones de recursos (historial de cambios)
/// Tabla transaccional que registra cada cambio en XP
model TransaccionRecurso {
  /// Identificador √∫nico
  id String @id @default(cuid())

  /// ID del recurso del estudiante
  recursos_estudiante_id String

  /// Tipo de recurso afectado
  tipo_recurso TipoRecurso

  /// Cantidad (positivo = ganancia, negativo = gasto)
  cantidad Int

  /// Raz√≥n de la transacci√≥n
  /// Ejemplos: "actividad_completada", "compra_tienda", "logro_desbloqueado", "racha_7_dias"
  razon String

  /// Metadata adicional (JSON flexible)
  /// Puede contener: actividad_id, item_id, logro_id, etc.
  metadata Json?

  /// Fecha de la transacci√≥n
  fecha DateTime @default(now())

  /// Timestamp de creaci√≥n
  createdAt DateTime @default(now())

  /// Relaciones
  recursosEstudiante RecursosEstudiante @relation(fields: [recursos_estudiante_id], references: [id], onDelete: Cascade)

  @@index([recursos_estudiante_id])
  @@index([tipo_recurso])
  @@index([fecha])
  @@map("transacciones_recurso")
}

// [ELIMINADO] Sistema de Tienda - m√≥dulo completo removido en cleanup
// Modelos eliminados: CategoriaItem, ItemTienda, ItemObtenido, CompraItem
// Enums eliminados: TipoItem, RarezaItem

// ============================================================================
// ENUMS PARA RECURSOS
// ============================================================================

/// Tipos de recursos del estudiante
enum TipoRecurso {
  XP

  @@map("tipo_recurso")
}

// ============================================================================
// SISTEMA DE GAMIFICACI√ìN V2 - COMPLETO
// ============================================================================
// Implementa el sistema optimizado con:
// - 67 logros con criterios autom√°ticos
// - 2 monedas: XP + Monedas
// - Sistema de rachas
// - Cat√°logo de cursos canjeables
// - Sistema de puntos para padres
// ============================================================================

// ==========================================
// MODELO: Logro (Definiciones)
// ==========================================

model Logro {
  id String @id @default(cuid())

  // Identificaci√≥n
  codigo      String @unique // "racha_7_dias", "completista", etc
  nombre      String // "Racha de Fuego"
  descripcion String
  categoria   String // "consistencia", "maestria", "social", etc

  // Recompensas
  xp_recompensa Int

  // Criterios de desbloqueo
  criterio_tipo  String // "racha_dias", "temas_completados", etc
  criterio_valor String // JSON con valor(es) necesarios

  // Metadata
  icono              String
  rareza             String // "comun", "raro", "epico", "legendario"
  secreto            Boolean @default(false)
  animacion          String? // ID de animaci√≥n desbloqueada
  titulo             String? // T√≠tulo que otorga
  badge              String? // Badge que otorga
  mensaje_desbloqueo String? // Mensaje especial al desbloquear
  extras             Json? // Array de extras (["texto1", "texto2"])

  // Orden y estado
  orden  Int     @default(0)
  activo Boolean @default(true)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relaciones
  logros_estudiantes LogroEstudiante[]

  // √çndices de performance para agrupaciones y filtros
  @@index([categoria], name: "idx_logros_categoria")
  @@index([rareza], name: "idx_logros_rareza")
  @@index([activo], name: "idx_logros_activo")
  @@map("logros_gamificacion")
}

// ==========================================
// MODELO: LogroEstudiante (Desbloqueados)
// ==========================================

model LogroEstudiante {
  id String @id @default(cuid())

  estudiante_id String
  logro_id      String

  fecha_desbloqueo DateTime @default(now())
  visto            Boolean  @default(false) // Para notificaciones

  // Relaciones
  estudiante Estudiante @relation(fields: [estudiante_id], references: [id], onDelete: Cascade)
  logro      Logro      @relation(fields: [logro_id], references: [id])

  @@unique([estudiante_id, logro_id])
  @@index([estudiante_id])
  @@index([logro_id])
  @@index([visto])
  @@map("logros_estudiantes_gamificacion")
}

// ==========================================
// MODELO: RachaEstudiante
// ==========================================

model RachaEstudiante {
  id            String @id @default(cuid())
  estudiante_id String @unique

  // Estado actual
  racha_actual Int @default(0)
  racha_maxima Int @default(0)

  // Fechas
  ultima_actividad    DateTime?
  inicio_racha_actual DateTime?

  // Metadata
  total_dias_activos Int @default(0)

  updated_at DateTime @updatedAt

  // Relaciones
  estudiante Estudiante @relation(fields: [estudiante_id], references: [id], onDelete: Cascade)

  @@index([estudiante_id])
  @@index([ultima_actividad])
  @@map("rachas_estudiantes")
}

// [ELIMINADO] Sistema Cat√°logo Cursos con Monedas - removido en cleanup
// Modelos eliminados: CursoCatalogo, SolicitudCanje, CursoEstudiante

// [ELIMINADO] Sistema PuntosPadre - modelos no utilizados removidos en cleanup

// ========================================
// SISTEMA DE CAMPA√ëAS NARRATIVAS
// ========================================

// ========================================
// COLONIA DE VERANO 2026
// ========================================

/// Modelo para inscripciones a la Colonia de Verano 2026
model ColoniaInscripcion {
  id String @id @default(cuid())

  tutor_id           String
  estado             String   @default("active") // "active", "blocked", "cancelled"
  descuento_aplicado Int // 0, 12 o 20
  total_mensual      Int // Monto que se cobra cada mes
  fecha_inscripcion  DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tutor       Tutor               @relation(fields: [tutor_id], references: [id], onDelete: Cascade)
  estudiantes ColoniaEstudiante[]
  pagos       ColoniaPago[]

  @@index([tutor_id])
  @@index([estado])
  @@map("colonia_inscripciones")
}

/// Modelo para estudiantes inscritos en la colonia
model ColoniaEstudiante {
  id String @id @default(cuid())

  inscripcion_id String
  estudiante_id  String // Referencia a la tabla estudiantes
  nombre         String
  edad           Int
  pin            String @unique // 4 d√≠gitos para acceso

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  inscripcion ColoniaInscripcion       @relation(fields: [inscripcion_id], references: [id], onDelete: Cascade)
  estudiante  Estudiante               @relation(fields: [estudiante_id], references: [id], onDelete: Cascade)
  cursos      ColoniaEstudianteCurso[]

  @@index([inscripcion_id])
  @@index([estudiante_id])
  @@index([pin])
  @@map("colonia_estudiantes")
}

/// Modelo para cursos seleccionados por cada estudiante
model ColoniaEstudianteCurso {
  id String @id @default(cuid())

  colonia_estudiante_id String
  course_id             String // ID del curso (ej: 'mat-juegos-desafios')
  course_name           String
  course_area           String // "Matem√°tica", "Programaci√≥n", "Ciencias"
  instructor            String
  day_of_week           String // "Lunes", "Martes", etc
  time_slot             String // "10:30-12:00", "14:30-16:00"
  precio_base           Int // 55000
  precio_con_descuento  Int // Despu√©s de aplicar descuento

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  estudiante ColoniaEstudiante @relation(fields: [colonia_estudiante_id], references: [id], onDelete: Cascade)

  @@index([colonia_estudiante_id])
  @@index([course_id])
  @@map("colonia_estudiante_cursos")
}

/// Modelo para pagos mensuales de la colonia
model ColoniaPago {
  id String @id @default(cuid())

  inscripcion_id            String
  mes                       String // "enero", "febrero", "marzo"
  anio                      Int // 2026
  monto                     Int
  estado                    String    @default("pending") // "pending", "paid", "failed", "cancelled"
  mercadopago_preference_id String?
  mercadopago_payment_id    String?
  fecha_vencimiento         DateTime // D√≠a 5 del mes
  fecha_pago                DateTime?
  fecha_creacion            DateTime  @default(now())
  processed_at              DateTime? // Para idempotencia en webhooks

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  inscripcion ColoniaInscripcion @relation(fields: [inscripcion_id], references: [id], onDelete: Cascade)

  @@index([inscripcion_id])
  @@index([estado])
  @@index([fecha_vencimiento])
  @@index([mercadopago_preference_id])
  @@index([processed_at])
  @@map("colonia_pagos")
}

/// =============================================================================
/// SECURITY: Sistema de Idempotencia de Webhooks
/// =============================================================================

/// Modelo para tracking de webhooks procesados de MercadoPago
/// Previene doble procesamiento de pagos (idempotencia)
///
/// MercadoPago puede enviar el mismo webhook m√∫ltiples veces por:
/// - Reintentos autom√°ticos si no respondemos 200 OK r√°pido
/// - Timeouts de red
/// - Problemas en infraestructura
///
/// Esta tabla garantiza que cada payment_id se procesa UNA SOLA VEZ
model WebhookProcessed {
  /// Identificador √∫nico del registro
  id String @id @default(uuid())

  /// ID del pago de MercadoPago (payment_id)
  /// UNIQUE constraint previene doble procesamiento
  payment_id String @unique

  /// Tipo de webhook procesado
  /// Ejemplos: "inscripcion", "membresia", "inscripcion2026", "colonia"
  webhook_type String

  /// Estado del pago cuando se proces√≥
  /// Ejemplos: "approved", "rejected", "pending"
  status String

  /// External reference del pago (para debugging)
  /// Formato: "inscripcion-{id}-estudiante-{id}-producto-{id}"
  external_reference String

  /// Timestamp de cuando se proces√≥ el webhook
  processed_at DateTime @default(now())

  /// Timestamp de creaci√≥n del registro
  created_at DateTime @default(now())

  /// √çndices para queries eficientes
  @@index([payment_id])
  @@index([processed_at])
  @@index([webhook_type])
  @@map("webhooks_processed")
}

/// Modelo de Audit Logs para rastrear todas las acciones cr√≠ticas del sistema
/// PROP√ìSITO: Seguridad, compliance y debugging de operaciones sensibles
///
/// CASOS DE USO:
/// - Detectar accesos no autorizados o sospechosos
/// - Auditor√≠as de seguridad y compliance (GDPR, regulaciones)
/// - Debugging de cambios inesperados en datos cr√≠ticos
/// - Forense digital en caso de incidentes
///
/// QU√â SE LOGUEA:
/// - Cambios en datos sensibles (precios, pagos, usuarios)
/// - Acciones administrativas cr√≠ticas (crear/modificar/eliminar usuarios)
/// - Eventos de seguridad (login fallido, MFA, cambio de permisos)
/// - Operaciones de pago (creaci√≥n, actualizaci√≥n de estados)
/// - Modificaciones de configuraci√≥n del sistema
///
/// RETENCI√ìN:
/// - Logs se mantienen indefinidamente para auditor√≠as
/// - Se pueden archivar logs antiguos (>1 a√±o) a almacenamiento fr√≠o
model AuditLog {
  /// ID √∫nico del log (CUID)
  id String @id @default(cuid())

  /// Timestamp de cuando ocurri√≥ la acci√≥n (indexado para b√∫squedas por fecha)
  timestamp DateTime @default(now())

  /// ID del usuario que realiz√≥ la acci√≥n (null para acciones del sistema)
  /// Formato: UUID del usuario (tutor, admin, docente, estudiante)
  user_id String?

  /// Tipo de usuario que realiz√≥ la acci√≥n
  /// Valores: "tutor", "admin", "docente", "estudiante", "system"
  user_type String?

  /// Email del usuario (para facilitar b√∫squedas)
  user_email String?

  /// Acci√≥n realizada
  /// Ejemplos: "create", "update", "delete", "login", "logout", "payment_created", "mfa_enabled"
  action String

  /// Entidad afectada
  /// Ejemplos: "Tutor", "Admin", "Pago", "Inscripcion", "Membresia", "Auth"
  entity_type String

  /// ID de la entidad afectada (si aplica)
  /// Formato: UUID de la entidad modificada
  entity_id String?

  /// Descripci√≥n legible de la acci√≥n
  /// Ejemplo: "Cre√≥ inscripci√≥n mensual para estudiante Juan P√©rez ($5000)"
  description String

  /// Cambios realizados (JSON)
  /// Formato: { "before": {...}, "after": {...} }
  /// IMPORTANTE: NO incluir datos sensibles como passwords
  changes Json?

  /// Metadata adicional (JSON)
  /// Puede incluir: IP, user agent, request ID, etc.
  metadata Json?

  /// Severidad del evento
  /// Valores: "info", "warning", "error", "critical"
  severity String @default("info")

  /// Categor√≠a del evento
  /// Valores: "auth", "payment", "user_management", "data_modification", "security"
  category String

  /// IP desde donde se realiz√≥ la acci√≥n
  ip_address String?

  /// User agent del cliente
  user_agent String?

  /// Request ID (para correlacionar con logs de aplicaci√≥n)
  request_id String?

  /// Timestamp de creaci√≥n del registro (siempre NOW)
  created_at DateTime @default(now())

  /// √çndices para queries eficientes
  @@index([timestamp])
  @@index([user_id])
  @@index([action])
  @@index([entity_type])
  @@index([category])
  @@index([severity])
  @@index([user_email])
  @@map("audit_logs")
}

/// Modelo de Rotaci√≥n de Secrets
/// PROP√ìSITO: Gesti√≥n segura de rotaci√≥n de secretos cr√≠ticos del sistema
///
/// PROBLEMA QUE RESUELVE:
/// - Secretos est√°ticos (JWT_SECRET, WEBHOOK_SECRET) nunca expiran
/// - Si un secret se compromete, afecta toda la seguridad del sistema
/// - No hay forma autom√°tica de rotar secrets sin downtime
///
/// SOLUCI√ìN:
/// - Rotaci√≥n autom√°tica cada 90 d√≠as
/// - Per√≠odo de gracia de 7 d√≠as donde ambos secrets son v√°lidos
/// - Historial de rotaciones para auditor√≠a
/// - Alertas antes de expiraci√≥n
///
/// SECRETS GESTIONADOS:
/// - JWT_SECRET: Para tokens de autenticaci√≥n
/// - MERCADOPAGO_WEBHOOK_SECRET: Para validaci√≥n de webhooks
///
/// FLUJO DE ROTACI√ìN:
/// 1. Sistema detecta que secret tiene 83+ d√≠as (7 d√≠as antes de expirar)
/// 2. Genera nuevo secret y lo marca como "pending"
/// 3. Admin recibe alerta para actualizar variables de entorno
/// 4. Al d√≠a 90, el secret viejo expira y solo el nuevo es v√°lido
/// 5. Per√≠odo de gracia permite transici√≥n sin downtime
model SecretRotation {
  /// ID √∫nico del registro
  id String @id @default(cuid())

  /// Tipo de secret
  /// Valores: "JWT_SECRET", "WEBHOOK_SECRET"
  secret_type String

  /// Versi√≥n del secret (incremental)
  /// Ejemplo: v1, v2, v3...
  version Int

  /// Hash SHA-256 del secret (para verificaci√≥n sin exponer el secret)
  /// El secret real se almacena en variables de entorno
  secret_hash String

  /// Estado del secret
  /// Valores: "active" (en uso), "pending" (nuevo, en per√≠odo de gracia), "expired" (ya no v√°lido)
  status String @default("active")

  /// Fecha de creaci√≥n del secret
  created_at DateTime @default(now())

  /// Fecha de expiraci√≥n (90 d√≠as despu√©s de created_at)
  expires_at DateTime

  /// Fecha en que fue rotado (cuando pas√≥ de active a expired)
  rotated_at DateTime?

  /// ID del admin que activ√≥ la rotaci√≥n
  rotated_by String?

  /// Metadata adicional (JSON)
  /// Puede incluir: raz√≥n de rotaci√≥n, IP de quien lo rot√≥, etc.
  metadata Json?

  @@unique([secret_type, version])
  /// √çndices para queries eficientes
  @@index([secret_type])
  @@index([status])
  @@index([expires_at])
  @@index([version])
  @@map("secret_rotations")
}

// ============================================================================
// [ELIMINADO] MATEATLETAS STUDIO - Sistema legacy eliminado
// CursoStudio, SemanaStudio, RecursoStudio, ComponenteCatalogo
// Enums: CategoriaStudio, TipoExperienciaStudio, MateriaStudio,
//        EstadoCursoStudio, EstadoSemanaStudio, TipoRecursoStudio, CategoriaComponente
// Reemplazado por nuevo sistema de contenido en FASE 2

// ============================================
// SISTEMA DE SUSCRIPCIONES RECURRENTES
// MercadoPago PreApproval - Diciembre 2025
// ============================================

/// Intervalo de cobro para suscripciones
enum IntervaloSuscripcion {
  DIARIO
  SEMANAL
  MENSUAL
  ANUAL
}

/// Estados internos de una suscripci√≥n
/// Mapeados desde MercadoPago PreApproval + estados de negocio
enum EstadoSuscripcion {
  PENDIENTE /// Esperando primer pago
  ACTIVA /// Pagos al d√≠a, acceso completo
  EN_GRACIA /// Fall√≥ cobro, dentro de 3 d√≠as de gracia
  MOROSA /// Pas√≥ grace period sin pago, acceso bloqueado
  PAUSADA /// Pausada voluntariamente (m√°x 30 d√≠as)
  CANCELADA /// Cancelada definitivamente
}

/// Plan de suscripci√≥n disponible
/// Define precios y configuraci√≥n de cobro
model PlanSuscripcion {
  /// Identificador √∫nico del plan
  id String @id @default(cuid())

  /// Nombre del plan (STEAM_LIBROS, STEAM_ASINCRONICO, STEAM_SINCRONICO)
  nombre String

  /// Descripci√≥n del plan para mostrar al usuario
  descripcion String?

  /// Precio base mensual en pesos argentinos
  precio_base Decimal @db.Decimal(10, 2)

  /// Moneda del precio (por defecto ARS)
  moneda String @default("ARS")

  /// Intervalo de cobro (mensual por defecto)
  intervalo IntervaloSuscripcion @default(MENSUAL)

  /// Cantidad de intervalos entre cobros (1 = cada mes)
  intervalo_cantidad Int @default(1)

  /// Si el plan est√° activo para nuevas suscripciones
  activo Boolean @default(true)

  /// Timestamp de creaci√≥n
  created_at DateTime @default(now())

  /// Timestamp de √∫ltima actualizaci√≥n
  updated_at DateTime @updatedAt

  /// Suscripciones asociadas a este plan
  suscripciones Suscripcion[]

  @@map("planes_suscripcion")
}

/// Suscripci√≥n activa de un tutor
/// Vincula un tutor con un plan y gestiona el ciclo de vida
model Suscripcion {
  /// Identificador √∫nico de la suscripci√≥n
  id String @id @default(cuid())

  /// ID del tutor propietario
  tutor_id String

  /// ID del plan de suscripci√≥n
  plan_id String

  // === MercadoPago PreApproval ===

  /// ID de la suscripci√≥n en MercadoPago (preapproval_id)
  mp_preapproval_id String? @unique

  /// Estado actual en MercadoPago (pending, authorized, paused, cancelled)
  mp_status String?

  // === Estado interno ===

  /// Estado actual de la suscripci√≥n
  estado EstadoSuscripcion @default(PENDIENTE)

  // === Fechas ===

  /// Fecha de inicio de la suscripci√≥n (primer pago confirmado)
  fecha_inicio DateTime?

  /// Fecha del pr√≥ximo cobro programado
  fecha_proximo_cobro DateTime?

  /// Fecha de cancelaci√≥n (si aplica)
  fecha_cancelacion DateTime?

  /// Fecha en que se paus√≥ la suscripci√≥n
  fecha_pausa DateTime?

  /// Fecha en que termina la pausa (m√°x 30 d√≠as despu√©s de fecha_pausa)
  fecha_fin_pausa DateTime?

  // === Grace Period ===

  /// D√≠as de gracia usados en el ciclo actual (m√°x 3)
  dias_gracia_usados Int @default(0)

  /// Fecha en que inici√≥ el per√≠odo de gracia actual
  fecha_inicio_gracia DateTime?

  // === Descuento familiar ===

  /// Porcentaje de descuento aplicado (0, 10, 20, etc.)
  descuento_porcentaje Int @default(0)

  /// Precio final despu√©s de aplicar descuento
  precio_final Decimal @db.Decimal(10, 2)

  // === Auditor√≠a ===

  /// Motivo de cancelaci√≥n (si fue cancelada)
  motivo_cancelacion String?

  /// Qui√©n cancel√≥: tutor_id, 'system', 'mercadopago'
  cancelado_por String?

  /// Timestamp de creaci√≥n
  created_at DateTime @default(now())

  /// Timestamp de √∫ltima actualizaci√≥n
  updated_at DateTime @updatedAt

  // === Optimistic Locking ===

  /// Versi√≥n del registro para control de concurrencia
  version Int @default(0)

  // === Relaciones ===

  /// Tutor propietario de la suscripci√≥n
  tutor Tutor @relation(fields: [tutor_id], references: [id], onDelete: Cascade)

  /// Plan de suscripci√≥n
  plan PlanSuscripcion @relation(fields: [plan_id], references: [id])

  /// Pagos realizados en esta suscripci√≥n
  pagos PagoSuscripcion[]

  /// Historial de cambios de estado
  historial HistorialEstadoSuscripcion[]

  @@index([tutor_id])
  @@index([estado])
  @@index([mp_preapproval_id])
  @@map("suscripciones")
}

/// Registro de cada pago de suscripci√≥n
/// Guarda el historial de cobros mensuales
model PagoSuscripcion {
  /// Identificador √∫nico del pago
  id String @id @default(cuid())

  /// ID de la suscripci√≥n a la que pertenece
  suscripcion_id String

  // === MercadoPago ===

  /// ID del pago en MercadoPago
  mp_payment_id String @unique

  /// Estado del pago en MercadoPago (approved, rejected, pending, etc.)
  mp_status String

  /// Detalle del estado (ej: "accredited", "cc_rejected_insufficient_amount")
  mp_status_detail String?

  // === Montos ===

  /// Monto cobrado
  monto Decimal @db.Decimal(10, 2)

  /// Moneda del pago
  moneda String @default("ARS")

  // === Per√≠odo cubierto ===

  /// Fecha de inicio del per√≠odo que cubre este pago
  periodo_inicio DateTime

  /// Fecha de fin del per√≠odo que cubre este pago
  periodo_fin DateTime

  // === Intento ===

  /// N√∫mero de intento (1 = primer intento, 2+ = reintentos)
  intento_numero Int @default(1)

  /// C√≥digo de error si fall√≥ (ej: "cc_rejected_insufficient_amount")
  error_code String?

  /// Mensaje de error legible
  error_message String?

  // === Fechas ===

  /// Fecha en que se realiz√≥ el cobro exitoso
  fecha_cobro DateTime?

  /// Timestamp de creaci√≥n (fecha del intento)
  created_at DateTime @default(now())

  // === Relaciones ===

  /// Suscripci√≥n a la que pertenece este pago
  suscripcion Suscripcion @relation(fields: [suscripcion_id], references: [id], onDelete: Cascade)

  @@index([suscripcion_id])
  @@map("pagos_suscripcion")
}

/// Historial de cambios de estado de suscripci√≥n
/// Para auditor√≠a y trazabilidad
model HistorialEstadoSuscripcion {
  /// Identificador √∫nico del registro
  id String @id @default(cuid())

  /// ID de la suscripci√≥n
  suscripcion_id String

  /// Estado anterior (null si es el primer estado)
  estado_anterior EstadoSuscripcion?

  /// Estado nuevo
  estado_nuevo EstadoSuscripcion

  /// Motivo del cambio
  motivo String?

  /// Qui√©n realiz√≥ el cambio: tutor_id, 'system', 'mercadopago'
  realizado_por String?

  /// Metadata adicional (JSON)
  metadata Json?

  /// Timestamp del cambio
  created_at DateTime @default(now())

  // === Relaciones ===

  /// Suscripci√≥n a la que pertenece este historial
  suscripcion Suscripcion @relation(fields: [suscripcion_id], references: [id], onDelete: Cascade)

  @@index([suscripcion_id])
  @@map("historial_estado_suscripcion")
}
