import { test, expect } from '@playwright/test';
import {
  loginEstudiante,
  navigateToGimnasio,
  waitForDashboardLoad,
  expectNoServerError,
  expectVisible,
  takeScreenshot,
  TEST_USERS,
} from './helpers/portal-helpers';

/**
 * Tests E2E Cr√≠ticos - Portal Estudiante
 *
 * Verificaci√≥n pre-lanzamiento de funcionalidades core:
 * - Login y autenticaci√≥n
 * - Navegaci√≥n al hub del gimnasio
 * - Creaci√≥n de avatar (Ready Player Me)
 * - Navegaci√≥n entre secciones principales
 *
 * Estos tests DEBEN PASAR antes del lanzamiento de hoy a las 12pm.
 */

test.describe('üéì Portal Estudiante - Tests Cr√≠ticos Pre-Lanzamiento', () => {
  // ============================================================================
  // TEST 1: Login Estudiante
  // ============================================================================

  test('‚úÖ Estudiante puede hacer login con credenciales v√°lidas', async ({
    page,
  }) => {
    console.log('\nüß™ TEST: Login estudiante');

    // Realizar login
    await loginEstudiante(page);

    // Verificar que redirigi√≥ correctamente
    await expect(page).toHaveURL(/\/estudiante/);

    // Verificar que no hay errores de servidor
    await expectNoServerError(page);

    // Screenshot para evidencia
    await takeScreenshot(page, 'estudiante-login-success', {
      fullPage: true,
    });

    console.log('‚úÖ TEST PASADO: Login estudiante exitoso\n');
  });

  // ============================================================================
  // TEST 2: Gimnasio Hub Carga Correctamente
  // ============================================================================

  test('‚úÖ Hub del gimnasio carga sin errores', async ({ page }) => {
    console.log('\nüß™ TEST: Hub gimnasio carga correctamente');

    // Login primero
    await loginEstudiante(page);

    // Navegar al gimnasio (puede ya estar ah√≠ despu√©s del login)
    await navigateToGimnasio(page);

    // Esperar que cargue completamente
    await waitForDashboardLoad(page);

    // Verificar que no hay errores 500/404
    await expectNoServerError(page);

    // Verificar que hay contenido en la p√°gina (no es una p√°gina en blanco)
    const bodyText = await page.locator('body').textContent();
    expect(bodyText).toBeTruthy();
    expect(bodyText!.length).toBeGreaterThan(100);

    // Screenshot
    await takeScreenshot(page, 'estudiante-gimnasio-hub', { fullPage: true });

    console.log('‚úÖ TEST PASADO: Hub del gimnasio carga correctamente\n');
  });

  // ============================================================================
  // TEST 3: Elementos del Hub Visibles
  // ============================================================================

  test('‚úÖ Elementos principales del hub est√°n visibles', async ({ page }) => {
    console.log('\nüß™ TEST: Elementos del hub visibles');

    await loginEstudiante(page);
    await navigateToGimnasio(page);
    await waitForDashboardLoad(page);

    // Verificar que existen elementos de navegaci√≥n comunes
    // Nota: Los selectores exactos pueden variar, usamos selectores flexibles

    const elementosEsperados = [
      {
        selector: 'text=/gimnasio/i, [href*="gimnasio"]',
        descripcion: 'Gimnasio',
      },
      {
        selector: 'text=/perfil/i, [href*="perfil"], button:has-text("Perfil")',
        descripcion: 'Perfil',
      },
      {
        selector:
          'text=/cursos/i, [href*="cursos"], text=/entrenamientos/i, [href*="entrenamientos"]',
        descripcion: 'Cursos/Entrenamientos',
      },
    ];

    // Verificar cada elemento (con timeout corto para no bloquear)
    for (const elemento of elementosEsperados) {
      const locator = page.locator(elemento.selector);
      const count = await locator.count();

      if (count > 0) {
        console.log(`  ‚úÖ Encontrado: ${elemento.descripcion}`);
      } else {
        console.warn(
          `  ‚ö†Ô∏è No encontrado: ${elemento.descripcion} (puede ser normal si no est√° en esta vista)`
        );
      }
    }

    // Screenshot final
    await takeScreenshot(page, 'estudiante-hub-elementos', {
      fullPage: true,
    });

    console.log('‚úÖ TEST PASADO: Elementos del hub verificados\n');
  });

  // ============================================================================
  // TEST 4: Navegaci√≥n a Perfil
  // ============================================================================

  test('‚úÖ Estudiante puede navegar a su perfil', async ({ page }) => {
    console.log('\nüß™ TEST: Navegaci√≥n a perfil');

    await loginEstudiante(page);
    await navigateToGimnasio(page);

    // Buscar link/bot√≥n de perfil
    const perfilLink = page.locator(
      'a[href*="/estudiante/perfil"], button:has-text("Perfil"), text=/mi perfil/i'
    );

    if ((await perfilLink.count()) > 0) {
      await perfilLink.first().click();
      await page.waitForLoadState('networkidle');

      // Verificar que naveg√≥
      await expect(page).toHaveURL(/\/estudiante\/perfil/);
      await expectNoServerError(page);

      console.log('  ‚úÖ Navegaci√≥n a perfil exitosa');
    } else {
      console.log(
        '  ‚ö†Ô∏è Link de perfil no encontrado en esta vista (puede ser modal o dropdown)'
      );

      // Intentar navegar directamente
      await page.goto('http://localhost:3000/estudiante/perfil');
      await page.waitForLoadState('networkidle');
      await expectNoServerError(page);

      console.log('  ‚úÖ Navegaci√≥n directa a perfil exitosa');
    }

    // Screenshot
    await takeScreenshot(page, 'estudiante-perfil', { fullPage: true });

    console.log('‚úÖ TEST PASADO: Navegaci√≥n a perfil\n');
  });

  // ============================================================================
  // TEST 5: Bot√≥n Crear Avatar Visible
  // ============================================================================

  test('‚úÖ Bot√≥n "Crear Avatar" est√° visible y funcional', async ({ page }) => {
    console.log('\nüß™ TEST: Bot√≥n crear avatar');

    await loginEstudiante(page);
    await navigateToGimnasio(page);
    await waitForDashboardLoad(page);

    // Buscar bot√≥n de crear avatar
    // Puede estar en diferentes lugares: modal, banner, men√∫
    const crearAvatarButton = page.locator(
      'button:has-text("Crear Avatar"), a:has-text("Crear Avatar"), text=/crear.*avatar/i, [href*="criar-avatar"]'
    );

    const count = await crearAvatarButton.count();

    if (count > 0) {
      console.log('  ‚úÖ Bot√≥n "Crear Avatar" encontrado');

      // Verificar que es clickeable
      await expect(crearAvatarButton.first()).toBeVisible();

      // Click en el bot√≥n
      await crearAvatarButton.first().click();

      // Esperar 2 segundos para que se abra modal o redirija
      await page.waitForTimeout(2000);

      // Verificar que se abri√≥ algo (modal, iframe, o nueva p√°gina)
      // Nota: Ready Player Me puede abrir en iframe o nueva pesta√±a

      // Opci√≥n 1: Verificar si hay iframe de Ready Player Me
      const readyPlayerIframe = page.frameLocator(
        'iframe[src*="readyplayer.me"], iframe[src*="rpm.io"]'
      );
      const iframeExists = await page
        .locator('iframe[src*="readyplayer.me"], iframe[src*="rpm.io"]')
        .count();

      if (iframeExists > 0) {
        console.log('  ‚úÖ Iframe de Ready Player Me detectado');
      } else {
        // Opci√≥n 2: Verificar si redirigi√≥ a p√°gina de creaci√≥n de avatar
        const currentUrl = page.url();
        if (currentUrl.includes('criar-avatar')) {
          console.log('  ‚úÖ Redirigi√≥ a p√°gina de creaci√≥n de avatar');
        } else {
          console.log(
            '  ‚ö†Ô∏è No se detect√≥ iframe ni redirecci√≥n (puede ser modal personalizado)'
          );
        }
      }

      // Screenshot
      await takeScreenshot(page, 'estudiante-crear-avatar-click', {
        fullPage: true,
      });

      console.log('‚úÖ TEST PASADO: Bot√≥n crear avatar funcional\n');
    } else {
      console.log(
        '  ‚ö†Ô∏è Bot√≥n "Crear Avatar" no encontrado (puede estar en perfil o ya tener avatar creado)'
      );

      // Intentar navegar directamente a la p√°gina de creaci√≥n
      await page.goto('http://localhost:3000/estudiante/criar-avatar');
      await page.waitForLoadState('networkidle');

      await expectNoServerError(page);

      // Screenshot
      await takeScreenshot(page, 'estudiante-criar-avatar-page', {
        fullPage: true,
      });

      console.log('  ‚úÖ P√°gina de crear avatar accesible directamente\n');
    }
  });

  // ============================================================================
  // TEST 6: Navegaci√≥n a Gamificaci√≥n
  // ============================================================================

  test('‚úÖ Estudiante puede navegar a gamificaci√≥n/logros', async ({ page }) => {
    console.log('\nüß™ TEST: Navegaci√≥n a gamificaci√≥n');

    await loginEstudiante(page);
    await navigateToGimnasio(page);

    // Intentar navegar a secci√≥n de gamificaci√≥n
    const gamificacionLink = page.locator(
      'a[href*="/estudiante/gamificacion"], button:has-text("Logros"), text=/logros/i, text=/gamificaci√≥n/i'
    );

    if ((await gamificacionLink.count()) > 0) {
      await gamificacionLink.first().click();
      await page.waitForLoadState('networkidle');

      await expectNoServerError(page);

      console.log('  ‚úÖ Navegaci√≥n a gamificaci√≥n exitosa');
    } else {
      console.log(
        '  ‚ÑπÔ∏è Link de gamificaci√≥n no encontrado, intentando navegaci√≥n directa'
      );

      // Intentar directamente
      await page.goto('http://localhost:3000/estudiante/gamificacion');
      await page.waitForLoadState('networkidle');

      await expectNoServerError(page);

      console.log('  ‚úÖ Navegaci√≥n directa a gamificaci√≥n exitosa');
    }

    // Screenshot
    await takeScreenshot(page, 'estudiante-gamificacion', { fullPage: true });

    console.log('‚úÖ TEST PASADO: Navegaci√≥n a gamificaci√≥n\n');
  });

  // ============================================================================
  // TEST 7: Logout Funciona
  // ============================================================================

  test('‚úÖ Estudiante puede cerrar sesi√≥n correctamente', async ({ page }) => {
    console.log('\nüß™ TEST: Logout estudiante');

    await loginEstudiante(page);
    await navigateToGimnasio(page);

    // Buscar bot√≥n de logout
    const logoutButton = page.locator(
      'button:has-text("Cerrar sesi√≥n"), button:has-text("Salir"), a:has-text("Cerrar sesi√≥n"), [data-testid="logout"]'
    );

    if ((await logoutButton.count()) > 0) {
      await logoutButton.first().click();

      // Esperar redirecci√≥n a login
      await page.waitForURL('**/login', { timeout: 10000 });

      // Verificar que est√° en login
      await expect(page).toHaveURL(/\/login/);

      console.log('  ‚úÖ Logout exitoso');
    } else {
      console.log(
        '  ‚ö†Ô∏è Bot√≥n de logout no encontrado (puede estar en men√∫ desplegable)'
      );
    }

    // Screenshot
    await takeScreenshot(page, 'estudiante-logout', { fullPage: false });

    console.log('‚úÖ TEST PASADO: Logout funcional\n');
  });
});

// ============================================================================
// TESTS CON M√öLTIPLES ESTUDIANTES
// ============================================================================

test.describe('üéì Portal Estudiante - Tests con M√∫ltiples Usuarios', () => {
  test('‚úÖ Ambos estudiantes de prueba pueden hacer login', async ({
    page,
  }) => {
    console.log('\nüß™ TEST: Login con m√∫ltiples estudiantes');

    // Estudiante 1: Lucas
    console.log('  üìù Probando estudiante 1 (Lucas)...');
    await loginEstudiante(
      page,
      TEST_USERS.estudiante1.email,
      TEST_USERS.estudiante1.password
    );
    await expectNoServerError(page);
    await takeScreenshot(page, 'estudiante1-lucas-login');

    // Logout
    await page.goto('http://localhost:3000/login');

    // Estudiante 2: Sof√≠a
    console.log('  üìù Probando estudiante 2 (Sof√≠a)...');
    await loginEstudiante(
      page,
      TEST_USERS.estudiante2.email,
      TEST_USERS.estudiante2.password
    );
    await expectNoServerError(page);
    await takeScreenshot(page, 'estudiante2-sofia-login');

    console.log('‚úÖ TEST PASADO: Ambos estudiantes pueden hacer login\n');
  });
});
