#!/bin/bash

# ============================================
# PRE-COMMIT HOOK - MATEATLETAS
# ============================================
# 1. VerificaciÃ³n de deployment crÃ­tico
# 2. Lint de TypeScript en archivos staged
# ============================================

echo ""
echo "ğŸ”’ Ejecutando verificaciones pre-commit..."
echo ""

# ============================================
# VERIFICACIÃ“N 1: Deployment Safety
# ============================================
echo "ğŸ“¦ [1/2] Verificando configuraciÃ³n de deploy..."
echo ""

if ! npm run verify:deploy; then
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "â›” COMMIT BLOQUEADO"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "La verificaciÃ³n de deploy fallÃ³."
  echo "Corrige los errores antes de hacer commit."
  echo ""
  echo "Para mÃ¡s informaciÃ³n: DEPLOYMENT.md"
  echo ""
  exit 1
fi

echo ""

# ============================================
# VERIFICACIÃ“N 2: TypeScript Quality
# ============================================
echo "ğŸ” [2/2] Verificando calidad de TypeScript..."
echo ""

# Obtener archivos staged de TypeScript
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' | grep '^apps/')

if [ -n "$STAGED_FILES" ]; then
  echo "Archivos a verificar:"
  echo "$STAGED_FILES" | sed 's/^/  - /'
  echo ""

  # Ejecutar script strict en archivos staged
  if ! bash scripts/lint-strict.sh $STAGED_FILES; then
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "â›” COMMIT BLOQUEADO"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Errores de lint detectados."
    echo "Corrige los errores antes de hacer commit."
    echo ""
    exit 1
  fi
else
  echo "No hay archivos TypeScript staged para verificar."
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Todas las verificaciones pasaron"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
